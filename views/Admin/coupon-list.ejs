<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Coupon Management</title>

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            background-color: #1c1c1c;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          
        }
        .main-content {
            margin-left: 260px;
            padding: 25px;
        }
        h1 {
            font-size: 28px;
            font-weight: 600;
        }
        .btn-primary-custom {
            background-color: #4e73df;
            border-color: #4e73df;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 500;
            color: #ffffff;
            transition: background 0.3s ease;
        }
        .btn-primary-custom:hover { background-color: #3c5bc9; }
        .card-dark {
            background-color: #1c1c1c;
            border: 1px solid #333;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .table-custom {
            width: 100%;
            border-collapse: collapse;
            background-color: #1c1c1c;
        }
        .table-custom thead {
            background-color: #222;
        }
        .table-custom thead th {
            color: #ffffff;
            text-transform: uppercase;
            font-weight: 600;
            padding: 12px;
            border-bottom: 2px solid #444;
        }
        .table-custom tbody td {
            color: #ffffff;
            padding: 12px;
            border-top: 1px solid #333;
            font-weight: 500;
        }
        .table-custom tbody tr:hover {
            background-color: #2a2a2a;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: #ffffff;
            display: inline-block;
        }
        .active-badge { background-color: #28a745; }
        .expired-badge { background-color: #dc3545; }
        .action-btn {
            padding: 4px 7px;
            font-size: 14px;
            border-radius: 6px;
        }
        .btn-info { background-color: #17a2b8; border-color: #17a2b8; color: #fff; }
        .btn-info:hover { background-color: #138496; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; color: #fff; }
        .btn-danger:hover { background-color: #c82333; }
        .table-responsive { overflow-x: auto; }
        .no-data { color: #bbbbbb; font-style: italic; text-align: center; padding: 20px 0; }
    </style>
</head>

<body>

<%- include("../partials/adminSide-bar.ejs") %>

<div class="main-content">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Coupons</h1>
        <a href="/admin/coupons/add" class="btn btn-primary-custom">
            <i class="fas fa-plus"></i> Add Coupon
        </a>
    </div>

    <div class="card card-dark shadow">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table-custom mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Coupon Code</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Min Price</th>
                            <th>Max Discount</th>
                            <th>Discount</th>
                            <th>Max Uses</th>
                            <th>Created At</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (coupons.length > 0) { %>
                            <% coupons.forEach((coupon, index) => { %>
                                <tr>
                                    <td><%= index + 1 %></td>
                                    <td><%= coupon.code %></td>
                                    <td><%= new Date(coupon.startDate).toLocaleDateString() %></td>
                                    <td><%= new Date(coupon.expiryDate).toLocaleDateString() %></td>
                                    <td>₹<%= coupon.minOrderAmount %></td>
                                    <td>₹<%= coupon.maxDiscountAmount || 'N/A' %></td>
                                    <td>
                                        <% if (coupon.discountType === 'percentage') { %>
                                            <%= coupon.discountValue %>% Off
                                        <% } else { %>
                                            ₹<%= coupon.discountValue %> Fixed
                                        <% } %>
                                    </td>
                                    <td><%= coupon.maxUses %></td>
                                    <td><%= new Date(coupon.createdAt).toLocaleDateString() %></td>
                                    <td>
                                      <%
                                        const expiryDate = new Date(coupon.expiryDate);
                                        expiryDate.setHours(23, 59, 59);

                                        const expired = expiryDate < new Date();
                                        %>

                                        <span class="status-badge <%= expired ? 'expired-badge' : 'active-badge' %>">
                                        <%= expired ? 'Expired' : 'Active' %>
                                        </span>
                                    </td>
                                    <td>
                                        <a href="/admin/coupons/edit/<%= coupon._id %>" class="btn btn-info btn-sm action-btn">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" onclick="confirmDelete('<%= coupon._id %>')" class="btn btn-danger btn-sm action-btn ms-1">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="11" class="no-data">No coupons found.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
async function confirmDelete(couponId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "This will permanently delete the coupon!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!'
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const res = await fetch(`/admin/coupons/delete/${couponId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: data.message
                    }).then(() => location.reload());
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message
                    });
                }
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong!'
                });
            }
        }
    });
}
</script>

</body>
</html>
