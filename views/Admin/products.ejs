<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
    <style>
        .main-content {
            margin-left: 260px;
            padding: 20px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-buttons .btn {
            min-width: 80px;
        }
         .page-link { padding: 8px 15px; border: 1px solid #ddd; color: #333; text-decoration: none; border-radius: 5px; }
        .page-link.active { background-color: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

<%- include("../partials/adminSide-bar.ejs") %>
<div class="main-content">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Products</h2>
        </div>
    </div>
    <header class="card-header text-center mb-20">
        <form action="" method="get" class="d-inline">
            <div class="input-group input-group-sm border border-1 border-grey rounded-pill" style="width: 500px; margin-left: 230px;">
                <input type="text" class="form-control border-0 rounded-pill" placeholder="Search products or brands" name="search">
                <button style="color: white;" class="btn border-0" type="submit">Search</button>
            </div>
        </form>
    </header>
    <div class="right mt-5">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col"><b>Image</b></th>
                    <th scope="col"><b>Product name</b></th>
                    <th scope="col"><b>Category</b></th>
                    <th scope="col"><b>Sale Price</b></th>
                    <th scope="col"><b>Offer Price</b></th>
                    <th scope="col"><b>Offer</b></th>
                    <th scope="col"><b>Stock</b></th>
                    <th scope="col"><b>Status</b></th>
                    <th scope="col"><b>Actions</b></th>
                </tr>
            </thead>
            <tbody>
                <% for(let i = data.length-1; i >= 0; i--){ %>
                <tr>
                    <td>
                        <img src="<%= data[i].displayImage || '/images/default-product.jpg' %>" alt="thumb" style="width:64px;height:64px;object-fit:cover;border-radius:6px;border:1px solid #ddd;">
                    </td>
                    <td><%= data[i].productName %></td>
                    <td><%= data[i].category.name %></td>
                    <td><%= data[i].variants[0].salePrice %></td>
                   <td>
    <% 
        let basePrice = data[i].variants[0].salePrice;
        let productOffer = data[i].variants[0].
productOffer || 0;
        let categoryOffer = data[i].categoryOffer || 0;
        let productOfferPrice =data[i].variants[0].
productOfferPrice
        basePrice +=productOfferPrice

        let bestOffer = Math.max(productOffer, categoryOffer);
        let bestOfferPrice =Math.max(productOfferPrice, categoryOffer);
        let finalPrice = bestOfferPrice;
    %>

    <% if(bestOffer > 0) { %>
        <span class="text-success fw-bold">₹<%= finalPrice %></span>
        <br>
        <small class="text-muted"><del>₹<%= basePrice %></del></small>
    <% } else { %>
        <span>—</span>
    <% } %>
</td>
<td>
    <!-- Show Active Offer -->
    <% if(bestOffer > 0) { %>
        <span class="badge bg-warning text-dark mb-2">
            <%= bestOffer %>% OFF
        </span><br>
    <% } %>

    <!-- Add Offer Button -->
    <button class="btn btn-primary btn-sm mt-1" 
            onclick="openOfferModal('<%= data[i]._id %>')">
        Add Offer
    </button>

    <!-- Remove Offer Button -->
    <button class="btn btn-danger btn-sm mt-1"
            onclick="removeOffer('<%= data[i]._id %>')">
        Remove
    </button>
</td>

                    <td><%= data[i].variants[0].stock %></td>
                    <td>
                        <% if(data[i].isBlocked) { %>
                        
                            <span class="badge bg-danger">Blocked</span>
                        <% } else { %>
                            <span class="badge bg-success">Active</span>
                        <% } %>
                    </td>
                   <td>
                        <div class="action-buttons">
                            <% if(data[i].isBlocked) { %>
                              
                                <button class="btn btn-success" onclick="confirmUnblock('<%= data[i]._id %>')">
                                    Unblock
                                </button>
                            <% } else { %>
                               
                                <button class="btn btn-danger" onclick="confirmBlock('<%= data[i]._id %>')">
                                    Block
                                </button>
                            <% } %>

                            <button class="btn btn-warning text-white" onclick="location.href='/admin/edit-product/<%= data[i]._id %>'">
                                Edit
                            </button>
                            <button class="btn btn-danger" onclick="confirmDelete('<%= data[i]._id %>', '<%= data[i].productName %>')">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<div class="container mt-3">
   <nav aria-label="Page navigation">
       <ul class="pagination justify-content-center mb-20" style="margin-right: 200px;">
           <% for (let i = 1; i <= totalPages; i++) { %>
           <li class="page-item <%=(i === currentPage) ? 'active' : '' %>">
               <a class="page-link" href="?page=<%= i %>"><%= i %></a>
           </li>
           <% } %>
       </ul>
   </nav>
</div>


<!-- Offer Modal -->
<div class="modal fade" id="offerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Offer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label>Offer Percentage (%)</label>
        <input type="number" id="offerValue" class="form-control" placeholder="Enter offer %" min="1" max="90">
        <input type="hidden" id="selectedProductId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="applyOffer()">Apply</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>

function openOfferModal(productId) {
    $("#selectedProductId").val(productId);
    $("#offerModal").modal("show");
}

function applyOffer() {
    const offer = $("#offerValue").val();
    const productId = $("#selectedProductId").val();

    if(offer < 1 || offer > 90) {
        Swal.fire("Invalid Offer", "Enter an offer between 1% and 90%", "warning");
        return;
    }

    $.ajax({
        url: `/admin/product-offer/${productId}`,
        method: "POST",
        data: { offer },
        success: function(res) {
            Swal.fire("Success", "Offer added!", "success")
                .then(()=> location.reload());
        }
    });
}

function removeOffer(productId) {
    $.ajax({
        url: `/admin/product-offer/remove/${productId}`,
        method: "POST",
        success: function(res) {
            Swal.fire("Removed", "Offer removed!", "success")
            .then(()=> location.reload());
        }
    });
}
    




    // Delete confirmation with SweetAlert
    function confirmDelete(productId, productName) {
        Swal.fire({
            title: 'Are you sure?',
            html: `You are about to delete <strong>${productName}</strong>. This action cannot be undone!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Send delete request
                $.ajax({
                    url: `/admin/delete-product/${productId}`,
                  type: 'DELETE',
                    success: function(response) {
                        if(response.success) {
                            Swal.fire(
                                'Deleted!',
                                `Product ${productName} has been deleted.`,
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire(
                                'Error!',
                                response.message || 'Failed to delete product.',
                                'error'
                            );
                        }
                    },
                    error: function() {
                        Swal.fire(
                            'Error!',
                            'Failed to delete product. Please try again.',
                            'error'
                        );
                    }
                });
            }
        });
    }

    // Block confirmation
    function confirmBlock(productId) {
        Swal.fire({
            title: 'Block Product?',
            text: "This product will be hidden from customers.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, block it!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Send block request
                $.ajax({
                    url: `/admin/block-product/${productId}`,
                    type: 'PATCH',
                    success: function(response) {
                        if(response.success) {
                            Swal.fire(
                                'Blocked!',
                                'Product has been blocked.',
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        }
                    }
                });
            }
        });
    }

    // Unblock confirmation
    function confirmUnblock(productId) {
        Swal.fire({
            title: 'Unblock Product?',
            text: "This product will be visible to customers.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, unblock it!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Send unblock request
                $.ajax({
                    url: `/admin/unblock-product/${productId}`,
                    type: 'PATCH',
                    success: function(response) {
                        if(response.success) {
                            Swal.fire(
                                'Unblocked!',
                                'Product has been unblocked.',
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        }
                    }
                });
            }
        });
    }
</script>

</body>
</html>