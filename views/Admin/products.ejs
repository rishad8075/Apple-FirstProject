<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
    <style>
        .main-content {
            margin-left: 260px;
            padding: 20px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-buttons .btn {
            min-width: 80px;
        }
        .pagination .page-link {
    background: #151517;
    border: 1px solid #262628;
    color: #e6e6e6;
}
.pagination .page-item.active .page-link.page-item  {
    background: #0066ff;
    border-color: #0066ff;
    
}
.pagination .page-link:hover {
    background: #232325;
    color: white;
}
         .page-link { padding: 8px 15px; border: 1px solid #ddd; color: #333; text-decoration: none; border-radius: 5px; }
        .page-link.active { background-color: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

<%- include("../partials/adminSide-bar.ejs") %>
<div class="main-content">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Products</h2>
        </div>
    </div>
    <header class="card-header text-center mb-20">
        <form action="" method="get" class="d-inline">
            <div class="input-group input-group-sm border border-1 border-grey rounded-pill" style="width: 500px; margin-left: 230px;">
                <input type="text" class="form-control border-0 rounded-pill" placeholder="Search products or brands" name="search">
                <button style="color: white;" class="btn border-0" type="submit">Search</button>
            </div>
        </form>
    </header>
    <div class="right mt-5">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col"><b>Image</b></th>
                    <th scope="col"><b>Product name</b></th>
                    <th scope="col"><b>Category</b></th>
                    <th scope="col"><b>Sale Price</b></th>
                    <th scope="col"><b>Offer Price</b></th>
                    <th scope="col"><b>Offer</b></th>
                    <th scope="col"><b>Stock</b></th>
                    <th scope="col"><b>Status</b></th>
                    <th scope="col"><b>Actions</b></th>
                </tr>
            </thead>
            <tbody>
                <% for(let i = data.length-1; i >= 0; i--){ %>
                <tr>
                    <td>
                        <img src="<%= data[i].displayImage || '/images/default-product.jpg' %>" alt="thumb" style="width:64px;height:64px;object-fit:cover;border-radius:6px;border:1px solid #ddd;">
                    </td>
                    <td><%= data[i].productName %></td>
                    <td><%= data[i].category.name %></td>
                    <td><%= data[i].variants[0].salePrice %></td>
            <td>
    â‚¹ <%= data[i].variants[0].finalPrice %>
</td>

                    <td>
    <% if(data[i].variants[0].productOffer > 0){ %>
        <span class="badge bg-success mb-1">
            <%= data[i].variants[0].productOffer %>% OFF
        </span>
        <br>
        <button class="btn btn-danger btn-sm"
            onclick="removeProductOffer(
                '<%= data[i]._id %>',
                '<%= data[i].variants[0]._id %>'
            )">
            Remove
        </button>
    <% } else { %>
        <button class="btn btn-info btn-sm"
            onclick="addProductOffer(
                '<%= data[i]._id %>',
                '<%= data[i].variants[0]._id %>'
            )">
            Add Offer
        </button>
    <% } %>
</td>
                    <td><%= data[i].variants[0].stock %></td>
                    <td>
                        <% if(data[i].isBlocked) { %>
                        
                            <span class="badge bg-danger">Blocked</span>
                        <% } else { %>
                            <span class="badge bg-success">Active</span>
                        <% } %>
                    </td>
                   <td>
                        <div class="action-buttons">
                            <% if(data[i].isBlocked) { %>
                              
                                <button class="btn btn-success" onclick="confirmUnblock('<%= data[i]._id %>')">
                                    Unblock
                                </button>
                            <% } else { %>
                               
                                <button class="btn btn-danger" onclick="confirmBlock('<%= data[i]._id %>')">
                                    Block
                                </button>
                            <% } %>

                            <button class="btn btn-warning text-white" onclick="location.href='/admin/edit-product/<%= data[i]._id %>'">
                                Edit
                            </button>
                            <button class="btn btn-danger" onclick="confirmDelete('<%= data[i]._id %>', '<%= data[i].productName %>')">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<div class="container mt-3">
   <nav aria-label="Page navigation">
       <ul class="pagination justify-content-center mb-20" style="margin-right: 200px;">
           <% for (let i = 1; i <= totalPages; i++) { %>
           <li class="page-item <%=(i === currentPage) ? 'active' : '' %>">
               <a class="page-link" href="?page=<%= i %>"><%= i %></a>
           </li>
           <% } %>
       </ul>
   </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
    function addProductOffer(productId, variantId) {
    Swal.fire({
        title: "Add Product Offer",
        input: "number",
        inputLabel: "Enter offer percentage",
        inputAttributes: {
            min: 1,
            max: 90
        },
        showCancelButton: true,
        confirmButtonText: "Apply",
    }).then((result) => {
        if (result.isConfirmed) {
            fetch("/admin/product/add-offer", {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    productId,
                    variantId,
                    offer: result.value
                })
            }).then(() => location.reload());
        }
    });
}

function removeProductOffer(productId, variantId) {
    Swal.fire({
        title: "Remove Offer?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes"
    }).then((result) => {
        if (result.isConfirmed) {
            fetch("/admin/product/remove-offer", {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ productId, variantId })
            }).then(() => location.reload());
        }
    });
}





    // Delete confirmation with SweetAlert
    function confirmDelete(productId, productName) {
        Swal.fire({
            title: 'Are you sure?',
            html: `You are about to delete <strong>${productName}</strong>. This action cannot be undone!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Send delete request
                $.ajax({
                    url: `/admin/delete-product/${productId}`,
                  type: 'DELETE',
                    success: function(response) {
                        if(response.success) {
                            Swal.fire(
                                'Deleted!',
                                `Product ${productName} has been deleted.`,
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire(
                                'Error!',
                                response.message || 'Failed to delete product.',
                                'error'
                            );
                        }
                    },
                    error: function() {
                        Swal.fire(
                            'Error!',
                            'Failed to delete product. Please try again.',
                            'error'
                        );
                    }
                });
            }
        });
    }

    // Block confirmation
    function confirmBlock(productId) {
        Swal.fire({
            title: 'Block Product?',
            text: "This product will be hidden from customers.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, block it!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Send block request
                $.ajax({
                    url: `/admin/block-product/${productId}`,
                    type: 'PATCH',
                    success: function(response) {
                        if(response.success) {
                            Swal.fire(
                                'Blocked!',
                                'Product has been blocked.',
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        }
                    }
                });
            }
        });
    }

    // Unblock confirmation
    function confirmUnblock(productId) {
        Swal.fire({
            title: 'Unblock Product?',
            text: "This product will be visible to customers.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, unblock it!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Send unblock request
                $.ajax({
                    url: `/admin/unblock-product/${productId}`,
                    type: 'PATCH',
                    success: function(response) {
                        if(response.success) {
                            Swal.fire(
                                'Unblocked!',
                                'Product has been unblocked.',
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        }
                    }
                });
            }
        });
    }
</script>

</body>
</html>