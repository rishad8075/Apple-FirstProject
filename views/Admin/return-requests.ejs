<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Return Requests</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        body { background-color: #181818; color: #e8e8e8; font-family: "Inter", sans-serif; }
        .admin-container { padding: 30px; min-height: 100vh; }
        .admin-card { margin-left: 250px; background: #181818; border: 1px solid #ffffff22; border-radius: 14px; padding: 28px; box-shadow: 0 0 25px rgba(0,0,0,0.45); }
        .table-dark-custom { background: #121214; color: #f1f1f1; border-collapse: separate; border-spacing: 0 12px; width: 100%; }
        .table-dark-custom th { background-color: #1f1f21; font-weight: 600; text-transform: uppercase; font-size: 12px; border-bottom: 1px solid #ffffff55; padding: 14px; letter-spacing: 0.7px; color: #ffffff; }
        .table-dark-custom td { padding: 16px 14px; vertical-align: middle; }
        .table-dark-custom tbody tr { background-color: #1a1a1c; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); transition: 0.25s ease; }
        .table-dark-custom tbody tr:hover { background-color: #1f1f21; }
        .badge-delivered { background-color: #2ecc71 !important; font-weight: 600; padding: 6px 10px; border-radius: 8px; }
        .badge-cancelled { background-color: #e74c3c !important; font-weight: 600; padding: 6px 10px; border-radius: 8px; }
        .badge-pending { background-color: #3498db !important; font-weight: 600; padding: 6px 10px; border-radius: 8px; }
        img.product-img { width: 50px; height: 50px; border-radius: 6px; margin-right: 8px; object-fit: cover; }
    </style>
</head>
<body>

<div class="admin-container">
    <div class="admin-header d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white">Return Requests</h2>
    </div>
    
    <%- include("../partials/adminSide-bar.ejs") %>

    <div class="admin-card">
        <div class="mb-4">
            <h5 class="text-white mb-0">Manage Pending Returns</h5>
            <small class="text-muted">Verify the returned product and process the wallet refund upon acceptance.</small>
        </div>

        <div class="table-responsive">
            <table class="table table-dark-custom align-middle">
                <thead>
                    <tr>
                        <th>Request ID</th>
                        <th>Order ID</th>
                        <th>User</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Reason</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if(requests && requests.length > 0) { %>
                        <% requests.forEach(req => { %>
                            <tr>
                                <td><%= req._id.toString().slice(-6) %></td>
                                <td>
                                    <a href="/admin/orders/detail/<%= req.orderId._id %>" class="text-info text-decoration-none">
                                        <%= req.orderId.orderId %>
                                    </a>
                                </td>
                                <td><%= req.userId.name %> (<%= req.userId.email %>)</td>
                                <td>
                                    <img src="<%= req.productImage %>" class="product-img" alt="product">
                                    <span><%= req.productName %></span>
                                </td>
                                <td><%= req.quantity %></td>
                                <td><%= req.reason %></td>
                                <td><%= new Date(req.createdAt).toLocaleDateString() %></td>
                                <td>
                                    <span class="badge 
                                        <% if(req.status === 'ACCEPTED') { %>badge-delivered
                                        <% } else if(req.status === 'REJECTED') { %>badge-cancelled
                                        <% } else { %>badge-pending
                                        <% } %>">
                                        <%= req.status %>
                                    </span>
                                </td>
                                <td>
                                    <% if (req.status === 'PENDING') { %>
                                        <button class="btn btn-success btn-sm approve-return-btn" data-requestid="<%= req._id %>">
                                            <i class="fas fa-check"></i> Accept
                                        </button>
                                        <button class="btn btn-danger btn-sm reject-return-btn" data-requestid="<%= req._id %>">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                    <% } else { %>
                                        <span class="text-muted">Completed</span>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">No return requests found.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Approve Return
    document.querySelectorAll('.approve-return-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const requestId = this.dataset.requestid;
            const result = await Swal.fire({
                title: 'Accept Return?',
                text: "Refund will be credited to wallet.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#2ecc71',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Accept'
            });

            if (result.isConfirmed) {
                const res = await fetch('/admin/returns/approve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ requestId })
                });
                const data = await res.json();
                if(data.success) Swal.fire('Approved!', data.message, 'success').then(()=> location.reload());
                else Swal.fire('Error', data.message || 'Failed', 'error');
            }
        });
    });

    // Reject Return
    document.querySelectorAll('.reject-return-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const requestId = this.dataset.requestid;
            const result = await Swal.fire({
                title: 'Reject Return?',
                text: "Order status remains unchanged.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e74c3c',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Reject'
            });

            if(result.isConfirmed) {
                const res = await fetch('/admin/returns/reject', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ requestId })
                });
                const data = await res.json();
                if(data.success) Swal.fire('Rejected!', data.message, 'success').then(()=> location.reload());
                else Swal.fire('Error', data.message || 'Failed', 'error');
            }
        });
    });
</script>
</body>
</html>
