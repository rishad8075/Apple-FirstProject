<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Return Requests</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        body { background-color: #181818; color: #e8e8e8; font-family: "Inter", sans-serif; letter-spacing: 0.2px; }
        .admin-container { background-color: transparent; min-height: 100vh; padding: 30px; }
        .admin-card { margin-left: 250px; background: #181818; border: 1px solid #ffffff22; border-radius: 14px; padding: 28px; box-shadow: 0 0 25px rgba(0,0,0,0.45); }
        .table-dark-custom { background: #121214; color: #f1f1f1; border-collapse: separate; border-spacing: 0 12px; width: 100%; }
        .table-dark-custom th { background-color: #1f1f21; font-weight: 600; text-transform: uppercase; font-size: 12px; border-bottom: 1px solid #ffffff55; padding: 14px; letter-spacing: 0.7px; color: #ffffff; }
        .table-dark-custom td { padding: 16px 14px; vertical-align: middle; }
        .table-dark-custom tbody tr { background-color: #1a1a1c; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); transition: 0.25s ease; }
        .table-dark-custom tbody tr:hover { background-color: #1f1f21; }
        .badge-delivered { background-color: #2ecc71 !important; font-weight: 600; padding: 6px 10px; border-radius: 8px; }
        .badge-cancelled { background-color: #e74c3c !important; font-weight: 600; padding: 6px 10px; border-radius: 8px; }
        .badge-pending { background-color: #3498db !important; font-weight: 600; padding: 6px 10px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="admin-container" >
    <div class="admin-header d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white">Return Requests</h2>
        </div>
    <%-include("../partials/adminSide-bar.ejs") %>
    
    <div class="admin-card">
        
        <div class="mb-4">
            <h5 class="text-white mb-0">Manage Pending Returns</h5>
            <small class="text-muted">Verify the returned product and process the wallet refund upon acceptance.</small>
        </div>

        <div class="table-responsive">
            <table class="table table-dark-custom align-middle">
                <thead>
                    <tr>
                        <th>Request ID</th>
                        <th>Order ID</th>
                        <th>User Name</th>
                        <th>Product Name</th>
                        <th>Qty</th>
                        <th>Reason</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if(requests && requests.length > 0) { %>
                        <% requests.forEach(request => { %>
                        <tr>
                            <td><%= request._id.toString().slice(-6) %></td> 
                            <td>
                                <a href="/admin/orders/detail/<%= request.orderId._id %>" class="text-info text-decoration-none">
                                    <%= request.orderId.orderId %>
                                </a>
                            </td>
                            <td><%= request.userId.name %></td> 
                            <td><%= request.productName %></td>
                            <td><%= request.quantity %></td>
                            <td><%= request.reason %></td>
                            <td><%= new Date(request.createdAt).toLocaleDateString('en-US') %></td>
                            
                            <td>
                                <span class="badge 
                                    <% if(request.status === 'ACCEPTED') { %>badge-delivered
                                    <% } else if(request.status === 'REJECTED') { %>badge-cancelled
                                    <% } else { %>badge-pending
                                    <% } %>
                                "><%= request.status %></span>
                            </td>
                            
                            <td>
                                <% if (request.status === 'PENDING') { %>
                                    <button class="btn btn-success btn-sm approve-return-btn" data-requestid="<%= request._id %>">
                                        <i class="fas fa-check"></i> Accept
                                    </button>
                                    <button class="btn btn-danger btn-sm reject-return-btn" data-requestid="<%= request._id %>">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                <% } else { %>
                                    <span class="text-muted">Completed</span>
                                <% } %>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">No return requests found.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
        
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- APPROVE RETURN LOGIC ---
    document.querySelectorAll('.approve-return-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const requestId = this.dataset.requestid;

            Swal.fire({
                title: 'Confirm Return Acceptance?',
                text: "The refund amount will be credited to the user's wallet and product stock will be incremented.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#2ecc71',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Accept Return'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        // POST request to the new controller endpoint
                        const res = await fetch('/admin/returns/approve', { 
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ requestId: requestId })
                        });
                        const data = await res.json();
                        if (data.success) {
                            Swal.fire('Approved!', data.message, 'success').then(() => location.reload());
                        } else {
                            Swal.fire('Error', data.message || 'Failed to approve return.', 'error');
                        }
                    } catch (err) {
                        Swal.fire('Error', 'Server error while processing approval.', 'error');
                    }
                }
            });
        });
    });

    // --- REJECT RETURN LOGIC ---
    document.querySelectorAll('.reject-return-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const requestId = this.dataset.requestid;

            Swal.fire({
                title: 'Reject Return Request?',
                text: "Are you sure you want to reject this request? The order status will remain unchanged.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e74c3c',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Reject It'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        // POST request to the new controller endpoint
                        const res = await fetch('/admin/returns/reject', { 
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ requestId: requestId }) 
                        });
                        const data = await res.json();
                        if (data.success) {
                            Swal.fire('Rejected!', data.message, 'success').then(() => location.reload());
                        } else {
                            Swal.fire('Error', data.message || 'Failed to reject return.', 'error');
                        }
                    } catch (err) {
                        Swal.fire('Error', 'Server error while processing rejection.', 'error');
                    }
                }
            });
        });
    });
</script>
</body>
</html>