<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APPLLE- Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0d6efd;
            --dark: #212529;
            --light: #f8f9fa;
            --accent: #ffc107;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .simple-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: #f8f9fa; border-bottom: 1px solid #ddd; }
        .simple-nav { display: flex; gap: 20px; }
        .simple-nav a { text-decoration: none; color: #333; font-weight: 500; }
        .user-greeting { font-weight: 500; }
        .search-section { margin: 20px 0; }
        .user-search { margin-top: 10px; display: flex; }
        .user-search input { padding: 8px 15px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; flex: 1; }
        .user-search button { padding: 8px 15px; background: #1e918b; color: white; border: none; border-radius: 0 4px 4px 0; }
        .shop-topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .sort-filter-container { display: flex; gap: 15px; align-items: center; }
        .sort-select { padding: 8px 15px; border-radius: 5px; border: 1px solid #ddd; }
        .product-list-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .sidebar { flex: 0 0 250px; padding: 20px; border: 1px solid #ddd; background-color: #f9f9f9; border-radius: 8px; margin-bottom: 20px; }
        .product-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .product-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; position: relative; transition: transform 0.3s, box-shadow 0.3s; background: white; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .product-img-container { height: 180px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .product-img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .wishlist-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.8); border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #ccc; }
        .wishlist-btn.active { color: red; }
        .product-title { font-weight: 600; margin-bottom: 5px; height: 40px; overflow: hidden; }
        .product-price { font-weight: 700; color: var(--primary); font-size: 1.1rem; margin: 10px 0; }
        .original-price { text-decoration: line-through; color: #999; font-size: 0.9rem; margin-left: 5px; }
        .add-to-cart-btn { background-color: var(--dark); color: #fff; padding: 8px; border: none; border-radius: 5px; cursor: pointer; width: 100%; transition: background-color 0.3s; }
        .add-to-cart-btn:hover { background-color: var(--primary); }
        .filter-section { margin-bottom: 20px; }
        .filter-title { font-weight: bold; margin-bottom: 10px; font-size: 16px; color: #333; }
        .filter-options { list-style: none; padding: 0; margin: 0; }
        .filter-item { margin: 8px 0; }
        .filter-item a { text-decoration: none; color: #333; display: block; padding: 5px; border-radius: 5px; }
        .filter-item a:hover, .filter-item.active a { background-color: #e9ecef; color: var(--primary); }
        .price-options { margin-top: 20px; }
        .price-option { padding: 8px 0; color: #333; cursor: pointer; }
        .price-option:hover, .price-option.active { color: var(--primary); font-weight: 500; }
        .pagination { display: flex; justify-content: center; margin: 30px 0; flex-wrap: wrap; }
        .page-item { margin: 0 5px; }
        .page-link { padding: 8px 15px; border: 1px solid #ddd; color: #333; text-decoration: none; border-radius: 5px; }
        .page-item.active .page-link { background-color: var(--primary); color: white; border-color: var(--primary); }
        .no-products { text-align: center; padding: 50px; grid-column: 1 / -1; }
        @media (max-width: 768px) {
            .product-list-container { flex-direction: column; }
            .sidebar { width: 100%; }
            .shop-topbar { flex-direction: column; align-items: stretch; }
            .sort-filter-container { width: 100%; }
            .sort-select { width: 100%; }
        }
    </style>
</head>
<body>
    <%- include("../partials/header.ejs") %>
    
    <div class="main-container">
        <section class="shop-page">
            <div class="search-section">
                <form action="/shop" method="GET" class="search-form" id="searchForm">
                    <input type="text" name="search" placeholder="Search products..." class="search-input" value="<%= searchQuery || '' %>">
                    <% if (searchQuery) { %>
                        <span class="search-clear" id="searchClear"><i class="fas fa-times"></i></span>
                    <% } %>
                    <button type="submit" class="search-button"><i class="fas fa-search"></i> Search</button>
                </form>
                
               
            </div>
            
            <div class="shop-topbar">
                <div class="sort-filter-container">
                    <select name="sort" id="sortSelect" class="sort-select">
                        <option value="">Sort By</option>
                        <option value="price_asc" <%= sortOption === 'price_asc' ? 'selected' : '' %>>Price: Low to High</option>
                        <option value="price_desc" <%= sortOption === 'price_desc' ? 'selected' : '' %>>Price: High to Low</option>
                        <option value="name_asc" <%= sortOption === 'name_asc' ? 'selected' : '' %>>Name: A-Z</option>
                        <option value="name_desc" <%= sortOption === 'name_desc' ? 'selected' : '' %>>Name: Z-A</option>
                    </select>
                </div>
            </div>
              <a href="<%= generateShopUrl({ search: null, category: null, price: null, sort: null }) %>" 
       class="btn btn-outline-secondary ms-3">
        Clear Filters
    </a>
            
            <div class="product-list-container">
                <aside class="sidebar">
                    <div class="filter-section">
                        <div class="filter-title">Categories</div>
                        <ul class="filter-options">
                            <li class="filter-item <%= !categoryFilter ? 'active' : '' %>">
                                <a href="<%= generateShopUrl({ category: null }) %>">All Categories</a>
                            </li>
                            <% categories.forEach(cat => { %>
                                <li class="filter-item <%= categoryFilter === cat._id.toString() ? 'active' : '' %>">
                                    <a href="<%= generateShopUrl({ category: cat._id.toString() }) %>">
                                        <%= cat.name %> (<%= cat.productCount %>)
                                    </a>
                                </li>
                            <% }); %>
                        </ul>
                    </div>
                    
                    <div class="price-options">
                        <div class="filter-title">Filter by Price</div>
                        <% const priceRanges = ['0-50000','50000-100000','100000-150000','150000-']; %>
                        <% priceRanges.forEach(range => { %>
                            <a style="text-decoration-line: none;" href="<%= generateShopUrl({ price: range }) %>">
                                <div class="price-option <%= priceFilter === range ? 'active' : '' %>">
                                    <% if(range==='0-50000'){ %>Under ₹50000<% } %>
                                    <% if(range==='50000-100000'){ %>₹50000 - ₹100000<% } %>
                                    <% if(range==='100000-150000'){ %>₹100000 - ₹150000<% } %>
                                    <% if(range==='150000-'){ %>Above ₹150000<% } %>
                                </div>
                            </a>
                        <% }); %>
                    </div>
                </aside>
                
                <main class="product-grid">
                    <% if (products.length > 0) { %>
                        <% products.forEach(product => { 
                            const variant = product.variants && product.variants.length > 0 ? product.variants[0] : null;
                        %>
                            <div class="product-card">
                                <button class="wishlist-btn <%= product.isWishlisted ? 'active' : '' %>" 
                                        data-product-id="<%= product._id %>">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <a style="text-decoration-line: none;" href="/productDetails/<%= product._id %>">
                                    <div class="product-img-container">
                                        <img src="<%= variant && variant.images[0] ? variant.images[0] : '/images/default-product.jpg' %>" 
                                             class="product-img" 
                                             alt="<%= product.productName %>">
                                    </div>
                                    <h5 class="product-title"><%= product.productName %></h5>
                                    <% if(variant) { %>
                                        <div class="product-price">
                                            ₹<%= variant.salePrice || variant.regularPrice %>
                                            <% if (variant.salePrice && variant.salePrice < variant.regularPrice) { %>
                                                <span class="original-price">₹<%= variant.regularPrice %></span>
                                            <% } %>
                                        </div>
                                    <% } %>
                                </a>
                                <button class="add-to-cart-btn" 
                                        data-product-id="<%= product._id %>" 
                                        data-variant-id="<%= variant ? variant._id : '' %>">
                                    <i class="fas fa-cart-plus me-2"></i>Add to Cart
                                </button>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="no-products">
                            <h4>No products found</h4>
                            <p>Try adjusting your search or filter criteria</p>
                            <a href="<%= generateShopUrl({ search: null, category: null, price: null }) %>" 
                               class="btn btn-primary mt-3">
                                Clear Filters
                            </a>
                        </div>
                    <% } %>
                </main>
            </div>
            
            <% if (totalPages > 1) { %>
                <div class="pagination">
                    <% if (currentPage > 1) { %>
                        <a href="<%= generateShopUrl({ page: currentPage - 1 }) %>" class="page-link">
                            &laquo; Previous
                        </a>
                    <% } %>
                    <% for (let i = 1; i <= totalPages; i++) { %>
                        <a href="<%= generateShopUrl({ page: i }) %>" 
                           class="page-link <%= currentPage === i ? 'active' : '' %>">
                            <%= i %>
                        </a>
                    <% } %>
                    <% if (currentPage < totalPages) { %>
                        <a href="<%= generateShopUrl({ page: currentPage + 1 }) %>" class="page-link">
                            Next &raquo;
                        </a>
                    <% } %>
                </div>
            <% } %>
        </section>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            const searchInput = $('.search-input');
            const searchClear = $('#searchClear');
            
            if (searchInput.val().trim() !== '') searchClear.show();
            
            searchInput.on('input', function() { searchClear.toggle(this.value.trim() !== ''); });
            searchClear.on('click', function() { searchInput.val(''); searchClear.hide(); $('#searchForm').submit(); });

            $('#sortSelect').on('change', function() {
                const url = new URL(window.location.href);
                if(this.value) { url.searchParams.set('sort', this.value); } 
                else { url.searchParams.delete('sort'); }
                window.location.href = url.toString();
            });

            $('.wishlist-btn').on('click', function(e) {
                e.preventDefault();
                const btn = $(this);
                const productId = btn.data('product-id');
                $.post('/wishlist/toggle', { productId }, function(res) {
                    if(res.success) { btn.toggleClass('active'); alert('Wishlist updated'); }
                });
            });

            $('.add-to-cart-btn').on('click', function(e) {
                e.preventDefault();
                const productId = $(this).data('product-id');
                const variantId = $(this).data('variant-id');
                $.post('/cart/add', { productId, variantId, quantity: 1 }, function(res) {
                    if(res.success) alert('Added to cart');
                });
            });

            $('.user-search button').on('click', function() {
                const query = $('.user-search input').val();
                if(query.trim() !== '') window.location.href = '/shop?search=' + encodeURIComponent(query);
            });

            $('.user-search input').on('keypress', function(e) { if(e.which === 13) $('.user-search button').click(); });
        });
    </script>
    <%- include("../partials/footer.ejs") %>
</body>
</html>
