<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Email Verification</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #6c63ff, #48c6ef);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            font-family: 'Poppins', sans-serif;
        }

        .otp-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(12px);
            border-radius: 18px;
            padding: 35px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0px 10px 25px rgba(0,0,0,0.15);
            color: #fff;
        }

        .otp-card h3 {
            font-weight: 600;
            text-align: center;
            margin-bottom: 25px;
        }

        .otp-input {
            height: 50px;
            font-size: 18px;
            letter-spacing: 2px;
            text-align: center;
            border-radius: 12px;
        }

        .otp-timer {
            margin-top: 15px;
            width: 75px;
            height: 75px;
            border-radius: 50%;
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(6px);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 17px;
            color: #fff;
            margin-left: auto;
            margin-right: auto;
            transition: 0.3s;
        }

        .btn-primary {
            border-radius: 12px;
            padding: 12px;
            font-size: 17px;
            font-weight: 600;
        }

        .resend-button {
            text-decoration: none;
            margin-top: 10px;
            font-weight: 500;
        }

        .alert {
            margin-top: 15px;
            border-radius: 10px;
        }

        a {
            color: #fff;
            font-weight: 500;
        }
    </style>
</head>
<body>

<div class="otp-card">
    <h3>Email Verification</h3>

    <form onsubmit="return validateOtpForm()">
        <input type="text" id="otp" name="otp" class="form-control otp-input mb-3" maxlength="6" placeholder="Enter OTP" required>

        <button type="submit" class="btn btn-primary w-100">Verify OTP</button>
    </form>

    <!-- Timer -->
    <div class="otp-timer" id="otpTimer">60</div>

    <!-- Resend Button -->
    <div class="text-center">
        <button type="button" class="btn btn-link resend-button" onclick="resendOtp()">Resend OTP</button>
    </div>

    <% if(locals.message && message.length >0){ %>
        <div class="alert alert-danger text-center"><%= message %></div>
    <% } %>

    <p class="text-center mt-3">Already verified? <a href="/login">Login now</a></p>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let otpTimerInterval;
let timer = 60;
const otpTimerElement = document.getElementById("otpTimer");
const resendBtn = document.querySelector(".resend-button");

resendBtn.disabled = true;

// Changing timer color based on remaining time
function updateTimerColor(percent) {
    if (percent > 50) otpTimerElement.style.background = "rgba(0,255,0,0.4)";
    else if (percent > 25) otpTimerElement.style.background = "rgba(255,200,0,0.4)";
    else otpTimerElement.style.background = "rgba(255,0,0,0.4)";
}

function startOtpTimer() {
    otpTimerElement.textContent = "60";
    resendBtn.disabled = true;

    otpTimerInterval = setInterval(() => {
        const seconds = timer;
        otpTimerElement.textContent = seconds;

        updateTimerColor((seconds / 60) * 100);

        timer--;

        if (timer < 0) {
            clearInterval(otpTimerInterval);
            otpTimerElement.textContent = "Expired";
            otpTimerElement.style.background = "rgba(255,0,0,0.7)";
            resendBtn.disabled = false;
        }
    }, 1000);
}

startOtpTimer();

function validateOtpForm() {
    const otp = document.getElementById("otp").value;

    $.ajax({
        type: "POST",
        url: "/verify-passForgot-otp",
        contentType: "application/json",
        data: JSON.stringify({ otp }),
        success(res) {
            if (res.success) {
                Swal.fire({
                    icon: "success",
                    title: "OTP Verified!",
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => window.location.href = res.redirectUrl);
            } else {
                Swal.fire({ icon: "error", title: "Invalid OTP", text: res.message });
            }
        },
        error() {
            Swal.fire({ icon: "error", title: "Error", text: "Something went wrong" });
        }
    });

    return false;
}

function resendOtp() {
    if (resendBtn.disabled) return;

    clearInterval(otpTimerInterval);
    timer = 60;
    startOtpTimer();

    $.ajax({
        type: "POST",
        url: "/resend-forgot-otp",
        success(res) {
            if (res.success) {
                Swal.fire({ icon: "success", title: "OTP sent!", timer: 1500, showConfirmButton: false });
            } else {
                Swal.fire({ icon: "error", title: "Failed", text: "Could not resend OTP" });
            }
        }
    });
}
</script>

</body>
</html>
