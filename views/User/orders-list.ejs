<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <style>
        body { background: #f8f9fa;
        height: 600px; }
            header,footer {
    position: relative;
    z-index: 1100; /* above sidebar */
}

        
        
        /* MAIN */
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        /* ORDER CARD */
        .card-box {
            background: #fff;
            border: 1px solid #ddd;
            border-left: 5px solid #ffcc00;
            padding: 20px;
            margin-bottom: 20px;
        }

        .product-preview img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px
             solid #ddd;
        }
        .top-banner {
    background: #ffffff;
    border-bottom: 1px solid #ddd;
}


        .btn-yellow { background: #ffcc00; font-weight: 600; }
        .btn-yellow:hover { background: #e6b800; }
    </style>
</head>

<body>
 <header style="z-index: 1100;">
    <%-include("../partials/header.ejs")  %>
 </header>

<!-- <div class="top-banner d-flex justify-content-center align-items-center py-2">
    <img src="/images/DALLÂ·E 2025-03-16 17.52.05 - A modern and sleek Apple product e-commerce homepage design. The layout features a large hero banner showcasing the latest iPhone with a clean white b.webp"
         alt="Banner"
         style="max-height: 250px; width: 100%;">
</div> -->
 <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a style="text-decoration: none;color: #000;" href="/"><i class="fas fa-home"></i> Home</a></li>
            <li class="breadcrumb-item"><a style="text-decoration: none;color: #000;" href="/orders">My Orders</a></li>
            <li class="breadcrumb-item active"></li>
        </ol>
    </nav>



<%-include("../partials/UserSide-bar.ejs") %>


<div class="main-content">

    <h4 class="mb-4">My Orders</h4>

    <!-- SEARCH -->
    <form class="d-flex mb-4" method="GET" action="/orders">
        <input type="text" name="search" class="form-control me-2"
               placeholder="Search by Order ID" value="<%= typeof search !== 'undefined' ? search : '' %>">
        <button class="btn btn-yellow"><i class="fas fa-search me-1"></i>Search</button>
        <a href="/orders" class="btn btn-outline-secondary"><i class="fas fa-redo-alt"></i> Clear Search</a>
    </form>

    <% if (!orders || orders.length === 0) { %>
        <p class="text-center p-5 border bg-light">No orders found.</p>
    <% } %>

    <% orders.forEach(order => { 
        const firstItem = order.orderItems[0];
    %>

        <div class="card-box">

            <!-- HEADER -->
            <div class="d-flex justify-content-between align-items-center">
                <div><strong>Order ID:</strong> <%= order.orderId %></div>

                <span class="badge
                    <% if(order.status === 'Delivered') { %> bg-success
                    <% } else if(order.status === 'Cancelled' || order.status === 'Returned') { %> bg-danger
                    <% } else if(order.status === 'Shipped') { %> bg-warning text-dark
                    <% } else { %> bg-info text-dark <% } %>">
                    <%= order.status %>
                </span>
            </div>

            <!-- DATE & PRICE -->
            <div>Order Date: <%= new Date(order.createdAt).toLocaleString() %></div>
            <div>Total: â‚¹ <%= order.totalPrice.toLocaleString('en-IN') %></div>

            <!-- PRODUCT IMAGES -->
            <div class="product-preview d-flex mt-2">
                <% order.orderItems.forEach(item => { %>
                    <img src="<%= item.image %>" class="me-2">
                <% }) %>
            </div>

            
            <div class="mt-3 d-flex gap-2 flex-wrap">
                <%if(order.status !=="PaymentFailed"){ %>

                <a href="/orders/detail/<%= order._id %>" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye me-1"></i> View Details
                </a>

                <%}%>

                <a href="/order/invoice/<%= order.orderId %>"
class="btn btn-outline-success btn-sm">
                    <i class="fas fa-file-invoice"></i> Invoice
                </a>

              
                <% if(firstItem.status !== 'Delivered' &&
                      firstItem.status !== 'Cancelled' &&
                      firstItem.status !== 'Returned' &&
                      order.status !== 'PaymentFailed' &&
                      firstItem.status !== 'Return Requested') { %>

                    <button class="btn btn-danger btn-sm cancel-order-btn"
                            data-orderid="<%= order._id %>">
                        <i class="fas fa-times"></i> Cancel Order
                    </button>
                <% } %>
                <%if(order.status == "PaymentFailed"){ %>
                     <button class="btn btn-danger btn-sm pay-order-btn"
                            data-orderid="<%= order._id %>">
                        Pay
                    </button>
                    <%}%>

                
               <% if (firstItem.status === 'Delivered' 
    && firstItem.status !== 'Returned' 
    && firstItem.status !== 'Return Requested') { %>

    <!-- Show FULL ORDER RETURN only once -->
     <button class="btn btn-outline-warning btn-sm return-order-btn" data-orderid="<%= order.orderId %>">
                        Return Full Order
                    </button>

    <!-- Show SINGLE PRODUCT RETURN inside loop -->
  

<% } %>

            </div>

        </div>
    <% }) %>

</div>
<footer style="z-index: 1100;" >
    <%-include("../partials/footer.ejs")  %>
</footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
   document.querySelectorAll(".pay-order-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
        const orderId = btn.dataset.orderid;

        Swal.fire({
            title: "Opening payment...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        // 1ï¸âƒ£ Ask backend to create Razorpay order
        const res = await fetch(`/api/payment/razorpay/retry/${orderId}`);
        const data = await res.json();
        Swal.close();

        if (!data.success) {
            return Swal.fire("Error", "Cannot start payment", "error");
        }

        // 2ï¸âƒ£ Razorpay options
        const options = {
            key: data.key,
            amount: data.amount,
            currency: "INR",
            name: "Your Store",
            description: "Retry Payment",
            order_id: data.razorpayOrderId,

            handler: async function (response) {
                // 3ï¸âƒ£ Verify payment
                const verifyRes = await fetch("/api/payment/razorpay/RetryVerify", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        orderId,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature
                    })
                });

                const verifyData = await verifyRes.json();

                if (verifyData.success) {
                    Swal.fire("Success ðŸŽ‰", "Payment completed", "success")
                        .then(() => location.reload());
                } else {
                    Swal.fire("Failed", "Payment verification failed", "error");
                }
            }
        };

        // 4ï¸âƒ£ Open Razorpay window
        const rzp = new Razorpay(options);
        rzp.open();
    });
});



/* CANCEL ORDER */
document.querySelectorAll(".cancel-order-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const orderId = btn.dataset.orderid;

        Swal.fire({
            title: "Cancel Order?",
            input: "select",
            inputOptions: {
                "Changed my mind": "Changed my mind",
                "Ordered by mistake": "Ordered by mistake",
                "Found a better price": "Found a better price",
                "Delivery is too slow": "Delivery is too slow",
                "Other": "Other"
            },
            inputPlaceholder: "Select a reason",
            showCancelButton: true,
            confirmButtonColor: "#dc3545",
            confirmButtonText: "Cancel Order",
            inputValidator: (value) => {
                if (!value) {
                    return "Please select a reason";
                }
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                const res = await fetch("/orders/cancel-entire", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        orderId,
                        reason: result.value
                    })
                });

                const data = await res.json();
                if (data.success) {
                    location.reload();
                } else {
                    Swal.fire("Error", "Unable to cancel order", "error");
                }
            }
        });
    });
});


/* RETURN ORDER */
document.querySelectorAll(".return-order-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
        const orderId = btn.dataset.orderid;
        const productId = btn.dataset.productid || null; 

        const { value: reason } = await Swal.fire({
            title: "Return Order?",
            input: "text",
            inputPlaceholder: "Enter reason for return",
            inputValidator: val => !val ? "Reason required" : null,
            showCancelButton: true,
            confirmButtonColor: "#0d6efd",
        });

        if (!reason) return; 

        try {
            const res = await fetch("/return-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderId, productId, reason })
            });

            const data = await res.json();

            if (data.success) {
                Swal.fire("Success!", data.message, "success").then(() => location.reload());
            } else {
                Swal.fire("Error", data.message || "Failed to process return.", "error");
            }

        } catch (err) {
            Swal.fire("Error", "Server error while processing return.", "error");
        }
    });
});

</script>

</body>
</html>
