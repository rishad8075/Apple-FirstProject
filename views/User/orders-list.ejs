<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders</title>

    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        body { background: #f8f9fa; }

        
        .account-sidebar {
            position: fixed;
            top: 0; left: 0;
            width: 250px; height: 100vh;
            background: #fff;
            padding: 30px 0;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        .sidebar-menu { list-style: none; padding: 0; }
        .sidebar-menu-item a {
            padding: 12px 25px;
            display: flex;
            align-items: center;
            color: #000;
            text-decoration: none;
            font-weight: 500;
        }
        .sidebar-menu-item a.active { background: #ffcc00; font-weight: 600; }
        .sidebar-menu-item a:hover { background: #f2f2f2; }
        .sidebar-menu-item a i { margin-right: 12px; }

        /* MAIN */
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        /* ORDER CARD */
        .card-box {
            background: #fff;
            border: 1px solid #ddd;
            border-left: 5px solid #ffcc00;
            padding: 20px;
            margin-bottom: 20px;
        }

        .product-preview img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .btn-yellow { background: #ffcc00; font-weight: 600; }
        .btn-yellow:hover { background: #e6b800; }
    </style>
</head>

<body>


<aside class="account-sidebar">
    <ul class="sidebar-menu">
        <li class="sidebar-menu-item"><a href="/user/profile"><i class="fas fa-user"></i> PERSONAL INFO</a></li>
        <li class="sidebar-menu-item"><a href="/user/addresseManagement"><i class="fas fa-map-marker-alt"></i> ADDRESSES</a></li>
        <li class="sidebar-menu-item"><a href="/orders" class="active"><i class="fas fa-clock"></i> ORDERS</a></li>
        <li class="sidebar-menu-item"><a href="/account/coupons"><i class="fas fa-ticket-alt"></i> COUPONS</a></li>
        <li class="sidebar-menu-item"><a href="/account/wallet"><i class="fas fa-wallet"></i> WALLET</a></li>
        <li class="sidebar-menu-item"><a href="/logout" class="text-danger"><i class="fas fa-sign-out-alt"></i> LOGOUT</a></li>
    </ul>
</aside>


<div class="main-content">

    <h4 class="mb-4">My Orders</h4>

    <!-- SEARCH -->
    <form class="d-flex mb-4" method="GET" action="/orders">
        <input type="text" name="search" class="form-control me-2"
               placeholder="Search by Order ID" value="<%= typeof search !== 'undefined' ? search : '' %>">
        <button class="btn btn-yellow"><i class="fas fa-search me-1"></i>Search</button>
    </form>

    <% if (!orders || orders.length === 0) { %>
        <p class="text-center p-5 border bg-light">No orders found.</p>
    <% } %>

    <% orders.forEach(order => { 
        const firstItem = order.orderItems[0];
    %>

        <div class="card-box">

            <!-- HEADER -->
            <div class="d-flex justify-content-between align-items-center">
                <div><strong>Order ID:</strong> <%= order.orderId %></div>

                <span class="badge
                    <% if(firstItem.status === 'Delivered') { %> bg-success
                    <% } else if(firstItem.status === 'Cancelled' || firstItem.status === 'Returned') { %> bg-danger
                    <% } else if(firstItem.status === 'Shipped') { %> bg-warning text-dark
                    <% } else { %> bg-info text-dark <% } %>">
                    <%= firstItem.status %>
                </span>
            </div>

            <!-- DATE & PRICE -->
            <div>Order Date: <%= new Date(order.createdAt).toLocaleString() %></div>
            <div>Total: â‚¹ <%= order.totalPrice.toLocaleString('en-IN') %></div>

            <!-- PRODUCT IMAGES -->
            <div class="product-preview d-flex mt-2">
                <% order.orderItems.forEach(item => { %>
                    <img src="<%= item.image %>" class="me-2">
                <% }) %>
            </div>

            
            <div class="mt-3 d-flex gap-2 flex-wrap">

                <a href="/orders/detail/<%= order._id %>" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-eye me-1"></i> View Details
                </a>

                <a href="/order/invoice/<%= order.orderId %>"
class="btn btn-outline-success btn-sm">
                    <i class="fas fa-file-invoice"></i> Invoice
                </a>

              
                <% if(firstItem.status !== 'Delivered' &&
                      firstItem.status !== 'Cancelled' &&
                      firstItem.status !== 'Returned') { %>

                    <button class="btn btn-danger btn-sm cancel-order-btn"
                            data-orderid="<%= order._id %>">
                        <i class="fas fa-times"></i> Cancel Order
                    </button>
                <% } %>

                
                <% if(firstItem.status === 'Delivered' && firstItem.status !== 'Returned') { %>

                    <button class="btn btn-secondary btn-sm return-order-btn"
                            data-orderid="<%= order._id %>">
                        <i class="fas fa-undo"></i> Return Order
                    </button>

                <% } %>

            </div>

        </div>
    <% }) %>

</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* CANCEL ORDER */
document.querySelectorAll(".cancel-order-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const orderId = btn.dataset.orderid;

        Swal.fire({
            title: "Cancel Order?",
            input: "text",
            inputPlaceholder: "Reason (optional)",
            showCancelButton: true,
            confirmButtonColor: "#dc3545",
            confirmButtonText: "Cancel Order"
        }).then(async result => {
            if (result.isConfirmed) {
                const res = await fetch("/orders/cancel-entire", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId, reason: result.value || "No reason" })
                });

                const data = await res.json();
                if (data.success) location.reload();
            }
        });
    });
});

/* RETURN ORDER */
document.querySelectorAll(".return-order-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const orderId = btn.dataset.orderid;

        Swal.fire({
            title: "Return Order?",
            input: "text",
            inputPlaceholder: "Reason (required)",
            inputValidator: val => !val ? "Reason required" : null,
            showCancelButton: true,
            confirmButtonColor: "#0d6efd",
        }).then(async result => {
            if (result.isConfirmed) {
                const res = await fetch("/orders/return-entire", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId, reason: result.value })
                });

                const data = await res.json();
                if (data.success) location.reload();
            }
        });
    });
});
</script>

</body>
</html>
