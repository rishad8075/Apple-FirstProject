<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - <%= order.orderId %></title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        body { background: #f8f9fa; }
        .breadcrumb { background: none; padding: 0; margin-bottom: 20px; }
        .card-box { 
            background: white; padding: 20px; margin-bottom: 20px;
            border-left: 5px solid #ffcc00; border: 1px solid #ddd; border-radius: 4px; 
        }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; color: #fff; }
        .status-Pending { background: #17a2b8; }
        .status-Shipped { background: #ffc107; color: #000; }
        .status-Delivered { background: #28a745; }
        .status-Cancelled, .status-Returned { background: #dc3545; }
        .status-Return-Requested { 
    background: #ffc107; 
    color: #000;
}
        table img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; }
    </style>
</head>

<body>
<div class="container mt-4">

    <!-- BREADCRUMBS -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a style="text-decoration: none;color: #000;" href="/"><i class="fas fa-home"></i> Home</a></li>
            <li class="breadcrumb-item"><a style="text-decoration: none;color: #000;" href="/orders">My Orders</a></li>
            <li class="breadcrumb-item active">Order <%= order.orderId %></li>
        </ol>
    </nav>

    <h4>Order Details</h4>

    <!-- ORDER INFO -->
    <div class="card-box">
        <div class="d-flex justify-content-between">
            <div><strong>Order ID:</strong> <%= order.orderId %></div>
                                    <!-- For order status -->
<span class="status-badge status-<%= order.status.replace(/\s+/g, '-') %>">
    <%= order.status %>
</span>
        </div>
        <div>Order Date: <%= order.createdAt.toLocaleString() %></div>
        <div>Payment Method: <%= order.paymentMethod %></div>
    </div>

    <!-- ADDRESS -->
    <div class="card-box">
        <h5>Shipping Address</h5>
        <p>
            <strong><%= order.address.fullName %></strong><br>
            <%= order.address.street %>, <%= order.address.city %>, <%= order.address.state %> - <%= order.address.postalCode %><br>
            <%= order.address.country %><br>
            Phone: <%= order.address.phone %>
        </p>
    </div>

    <!-- PRODUCTS -->
    <div class="card-box">
        <h5>Products</h5>
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Subtotal</th>
                        <th>Discount</th>
                        <th>Tax</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>

                <tbody>
                    <% order.orderItems.forEach(item => { %>
                    <tr>
                        <td><img src="<%= item.image %>" alt=""></td>
                        <td><%= item.name %></td>
                        <td><%= item.quantity %></td>
                        <td>₹ <%= item.price.toLocaleString('en-IN') %></td>
                        <td>₹ <%= item.subtotal.toLocaleString('en-IN') %></td>
                          <td>
            <% if(order.coupon) { %>
                <span class="text-success fw-bold"><%= order.coupon %></span>
            <% } else { %>
                <span>-</span>
            <% } %>
        </td>

                        <td>₹ <%= item.tax.toLocaleString('en-IN') %></td>
                        <td>
    

                        <!-- For each item status -->
                        <span class="status-badge status-<%= item.status.replace(/\s+/g, '-') %>">
                            <%= item.status %>
                        </span>
                        </td>

                        <!-- ACTION BUTTONS -->
                        <td>
                            <% if(item.status === "Delivered") { %>
                                <!-- RETURN PRODUCT -->
                                <button class="btn btn-sm btn-warning return-product-btn"
                                    data-orderid="<%= order.orderId %>"
                                    data-productid="<%= item.productId %>"
                                    data-quantity = "<% item.quantity %>">

                                    Return
                                </button>
                            <% } %>
                              <% if(item.status === "Return Requested") { %>
                               
                                <button class="btn btn-sm btn-warning returnCancel-product-btn"
                                    data-orderid="<%= order.orderId %>"
                                    data-productid="<%= item.productId %>"
                                    data-quantity = "<% item.quantity %>">

                                    Cancel Return
                                </button>
                            <% } %>

                            <% if(item.status !== "Delivered" && item.status !== "Cancelled" && item.status !== "Returned"  && item.status !== "Return Requested") { %>
                                <!-- CANCEL PRODUCT -->
                                <button class="btn btn-sm btn-danger cancel-product-btn"
                                    data-orderid="<%= order._id %>"
                                    data-productid="<%= item.productId %>">
                                    Cancel
                                </button>
                            <% } %>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ORDER SUMMARY -->
    <div class="card-box">
        <h5>Order Summary</h5>

        <p>Total Price: ₹ <%= order.totalPrice.toLocaleString('en-IN') %></p>

        <% if(order.shippingCharge) { %>
            <p>Shipping: ₹ <%= order.shippingCharge.toLocaleString('en-IN') %></p>
        <% } %>

        <% if(order.coupon) { %>
            <p>Coupon Discount: ₹ <%= order.coupon.toLocaleString('en-IN') %></p>
        <% } %>

        <p>
            <strong>Grand Total: ₹ 
                <%= order.totalPrice .toLocaleString('en-IN') %>
            </strong>
        </p>
    </div>

   
    <% if(order.status !== "Delivered" && order.status !== "Cancelled" && order.status !== "Returned" && order.status !=="Return Requested") { %>
        <button class="btn btn-danger cancel-order-btn" data-orderid="<%= order._id %>">
            <i class="fas fa-times-circle"></i> Cancel Entire Order
        </button>
    <% } %>

   
    <% if(order.status === "Delivered" ) { %>
        <button class="btn btn-warning mt-3 return-order-btn" data-orderid="<%= order.orderId %>">
            <i class="fas fa-undo"></i> Return Entire Order
        </button>
    <% } %>

</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

document.querySelectorAll('.return-order-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const orderId = btn.dataset.orderid;

        Swal.fire({
            title: 'Return Entire Order?',
            input: 'text',
            inputPlaceholder: 'Reason is required',
            inputValidator: v => !v && 'Reason required!',
            showCancelButton: true,
            confirmButtonColor: '#ffc107',
            confirmButtonText: 'Return Order'
        }).then(async result => {
            if(result.isConfirmed){
                const res = await fetch("/return-order", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ orderId, reason: result.value })
                });
                const data = await res.json();
                if(data.success) Swal.fire('Returned!', '', 'success').then(() => location.reload());
                else Swal.fire('Error', data.message, 'error');
            }
        });
    });
});

document.querySelectorAll(".returnCancel-product-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const orderId = btn.dataset.orderid;
    const productId = btn.dataset.productid;

    Swal.fire({
      title: "Cancel Return?",
      showCancelButton: true,
      confirmButtonColor: "#ffc107",
      confirmButtonText: "Cancel Return Request",
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          const res = await fetch("/ReturnRequest/Cancel", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId, productId }),
          });

          const data = await res.json();

          if (data.success) {
            Swal.fire("Return Cancelled", "", "success");
        window.location.reload()
          } else {
            Swal.fire("Error", data.message, "error");
          }
        } catch (error) {
          Swal.fire("Error", "Something went wrong", "error");
          console.error(error);
        }
      }
    });
  });
});



document.querySelectorAll('.return-product-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const orderId = btn.dataset.orderid;
        const productId = btn.dataset.productid;
        const quantity =btn.dataset.quantity

        Swal.fire({
            title: 'Return this Product?',
            input: 'text',
            inputPlaceholder: 'Reason is required',
            inputValidator: v => !v && 'Reason required!',
            showCancelButton: true,
            confirmButtonColor: '#ffc107',
            confirmButtonText: 'Return Product'
        }).then(async result => {
            if(result.isConfirmed){
                const res = await fetch("/return-order", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ orderId, productId, reason: result.value,quantity })
                });
                const data = await res.json();
                if(data.success) Swal.fire('Returned!', '', 'success').then(() => location.reload());
                else Swal.fire('Error', data.message, 'error');
            }
        });
    });
});




document.querySelectorAll('.cancel-order-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const orderId = btn.dataset.orderid;

        Swal.fire({
            title: 'Cancel Entire Order?',
            input: 'select',
            inputOptions: {
                'Changed my mind': 'Changed my mind',
                'Ordered by mistake': 'Ordered by mistake',
                'Found a better price': 'Found a better price',
                'Delivery delay': 'Delivery delay',
                'Other': 'Other'
            },
            inputPlaceholder: 'Select a reason',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Cancel Order',
            inputValidator: (value) => {
                if (!value) {
                    return 'Please select a cancel reason';
                }
            }
        }).then(async result => {
            if (result.isConfirmed) {
                const res = await fetch('/orders/cancel-entire', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId,
                        reason: result.value
                    })
                });

                const data = await res.json();

                if (data.success) {
                    Swal.fire('Cancelled!', 'Your order has been cancelled.', 'success')
                        .then(() => location.reload());
                } else {
                    Swal.fire('Error', data.message || 'Something went wrong', 'error');
                }
            }
        });
    });
});


/* ---------------- CANCEL PRODUCT ---------------- */
document.querySelectorAll('.cancel-product-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const orderId = btn.dataset.orderid;
        const productId = btn.dataset.productid;

        Swal.fire({
            title: 'Cancel Product?',
            input: 'select',
            inputOptions: {
                'Ordered by mistake': 'Ordered by mistake',
                'Product no longer needed': 'Product no longer needed',
                'Found cheaper alternative': 'Found cheaper alternative',
                'Delivery delay': 'Delivery delay',
                'Other': 'Other'
            },
            inputPlaceholder: 'Select a reason',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Cancel Product',
            inputValidator: (value) => {
                if (!value) {
                    return 'Please select a cancel reason';
                }
            }
        }).then(async result => {
            if (result.isConfirmed) {
                const res = await fetch('/orders/cancel-product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId,
                        productId,
                        reason: result.value
                    })
                });

                const data = await res.json();

                if (data.success) {
                    Swal.fire('Cancelled!', 'Product has been cancelled.', 'success')
                        .then(() => location.reload());
                } else {
                    Swal.fire('Error', data.message || 'Something went wrong', 'error');
                }
            }
        });
    });
});

</script>

</body>
</html>
