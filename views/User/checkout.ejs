<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <style>
        body { background: #f6f6f6; }

        .checkout-grid {
            width: 90%;
            margin: 30px auto;
            display: grid;
            grid-template-columns: 1.3fr 1fr;
            gap: 40px;
        }

        .card-box {
            background: white;
            padding: 25px;
            border: 1px solid #ddd;
        }

        .product-box {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 1px solid #ddd;
            margin-right: 20px;
        }

        .address-box {
            background: white;
            padding: 18px;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        .address-active {
            border: 2px solid black !important;
        }

        .btn-yellow {
            background: #ffcc00;
            border: none;
            padding: 10px 25px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-outline {
            border: 1px solid #000;
            width: 100%;
            padding: 12px;
            text-transform: uppercase;
        }
    </style>
</head>

<body>
<header>
    <%- include("../partials/header.ejs") %>
</header>

<div class="container mt-4">
    <h4>CHECKOUT</h4>
</div>

<div class="checkout-grid">

    <!-- LEFT SIDE: PRODUCTS LIST -->
    <div class="card-box">
        <h5>Your Items (<%= items.length %>)</h5>
        <hr>
        <% items.forEach(item => { %>
            <div class="product-box">
                <img src="<%= item.image %>" class="product-image">
                <div style="flex:1">
                    <div class="fw-semibold"><%= item.name %></div>
                    <div class="text-muted">Qty: <%= item.qty %></div>
                </div>
                <div class="text-end">
                    <div>₹ <%= item.price.toLocaleString('en-IN') %></div>
                    <small class="text-muted">Total: ₹ <%= item.total.toLocaleString('en-IN') %></small>
                </div>
            </div>
        <% }) %>
    </div>

    <!-- RIGHT SIDE: ADDRESS + SUMMARY -->
    <div>
        <!-- ADDRESS SELECTION -->
        <h6 class="mb-2">SELECT ADDRESS</h6>
        <% addresses.forEach(addr => { %>
            <div class="address-box mb-3 <%= addr.isDefault ? 'address-active' : '' %>" data-id="<%= addr._id %>">
                <div>
                    <strong><%= addr.fullname %></strong> — <%= addr.mobile %><br>
                    <%= addr.houseName %>, <%= addr.locality %><br>
                    <%= addr.district %>, <%= addr.state %> - <%= addr.pincode %>
                </div>
                <div class="mt-2 d-flex justify-content-between align-items-center">
                    <a href="/user/edit-address/<%= addr._id %>" class="btn btn-warning btn-sm">EDIT</a>
                    <label class="mb-0">
                        <input type="radio" class="set-default-radio" name="defaultAddress" value="<%= addr._id %>" <%= addr.isDefault ? 'checked' : '' %> >
                        Default
                    </label>
                </div>
            </div>
        <% }) %>

        <a href="/checkout/AddAddress">
            <button class="btn-outline mt-2">ADD NEW ADDRESS</button>
        </a>

        <!-- ORDER SUMMARY -->
        <div class="card-box mt-4">
            <h5>Order Summary</h5>
            <hr>
            <div class="d-flex justify-content-between">
                <span>Subtotal</span>
                <span>₹ <%= subtotal.toLocaleString('en-IN') %></span>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span>Tax</span>
                <span>₹ <%= tax || 0 %></span>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span>Shipping Charge</span>
                <span>₹ <%= shipping || 0 %></span>
            </div>
               <div class="d-flex justify-content-between mt-2">
                <span>Delivery Charge</span>
                <span>₹ <%= deliveryCharge || 0 %></span>
            </div>
                            <div class="mt-3">
                    <label class="fw-semibold">Have a Coupon?</label>
                    <div class="input-group mt-2">
                        <input type="text" name="couponCode" id="couponCode" class="form-control" placeholder="Enter coupon code">
                        <button class="btn btn-dark" id="applyCouponBtn">Apply</button>
                    </div>

                    <% if (appliedCoupon) { %>
                        <div class="mt-2">
                            <span class="badge bg-success">Applied: <%= appliedCoupon %></span>
                            <button class="btn btn-sm btn-danger ms-2" id="removeCouponBtn">Remove</button>
                        </div>
                    <% } %>
                </div>

                <div class="d-flex justify-content-between mt-2">
                    <span>Coupon Applied</span>
                    <span class="text-success fw-bold">- ₹<%= discountAmount %></span>
                </div>
            <!-- <div class="d-flex justify-content-between mt-2">
                <span>Offer</span>
                <span><%=appliedCoupon %> %</span>
            </div> -->
            <hr>
            <div class="d-flex justify-content-between fw-bold">
                <span>Total</span>
                <span>₹ <%= total.toLocaleString('en-IN') %></span>
            </div>

            <!-- Proceed to Payment button -->
            <div class="text-center my-4">
                <button id="proceedBtn" class="btn-yellow" disabled>Proceed to Payment</button>
            </div>
        </div>
    </div>
</div>

<%- include("../partials/footer.ejs") %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let selectedAddress = null;

    // Clicking address box to select for checkout
    document.querySelectorAll('.address-box').forEach(box => {
        box.addEventListener('click', function(e) {
            if (e.target.classList.contains('set-default-radio')) return;
            selectedAddress = this.dataset.id;

            document.querySelectorAll('.address-box').forEach(b => b.classList.remove('address-active'));
            this.classList.add('address-active');

            document.getElementById('proceedBtn').disabled = false;
        });
    });

    // Handle default radio click
    document.querySelectorAll('.set-default-radio').forEach(radio => {
        radio.addEventListener('change', async function() {
            const addressId = this.value;

            Swal.fire({
                title: "Set this Address as default?",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: '#FF9500',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, set as default'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch(`/user/set-default-address/${addressId}`, {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json" }
                        });
                        const data = await res.json();

                        if (data.success) {
                            document.querySelectorAll('.address-box').forEach(b => b.classList.remove('address-active'));
                            this.closest('.address-box').classList.add('address-active');

                            selectedAddress = addressId;
                            document.getElementById('proceedBtn').disabled = false;

                            Swal.fire('Updated!', 'Default address set successfully', 'success');
                        } else {
                            Swal.fire('Error!', data.message, 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        Swal.fire('Error!', 'Server error', 'error');
                    }
                } else {
                    this.checked = !this.checked;
                }
            });
        });
    });

    // Redirect to payment page with selected address
    document.getElementById('proceedBtn').addEventListener('click', () => {
        if (!selectedAddress) {
            Swal.fire('Select Address', 'Please select an address to continue.', 'warning');
            return;
        }

        const query = new URLSearchParams({ addressId: selectedAddress }).toString();
        window.location.href = `/payment?${query}`;
    });

    //coupon

    document.getElementById("applyCouponBtn")?.addEventListener("click", async () => {
    const code = document.getElementById("couponCode").value.trim();

    if (!code) {
        Swal.fire("Error", "Please enter a coupon code", "warning");
        return;
    }

    const res = await fetch("/apply-coupon", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ couponCode: code })
    });

    const data = await res.json();

    if (data.success) {
        Swal.fire("Success", data.message, "success")
            .then(() => location.reload());
    } else {
        Swal.fire("Error", data.message, "error");
    }
});

document.getElementById("removeCouponBtn")?.addEventListener("click", async () => {
    const res = await fetch("/remove-coupon", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
    });

    const data = await res.json();

    if (data.success) {
        Swal.fire("Removed", data.message, "success")
            .then(() => location.reload());
    } else {
        Swal.fire("Error", data.message, "error");
    }
});


</script>

</body>
</html>
