<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Shopping Cart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f7f7f7; }
        .container { max-width: 1200px; padding: 0 15px; }
        h2 { font-weight: 600; font-size: 2.2em; margin-bottom: 30px; }
        
        /* Main Grid Layout */
        .cart-layout { display: flex; gap: 30px; }
        .cart-items-column { flex: 2; }
        .cart-summary-column { flex: 1; min-width: 350px; }

        /* Item Row Styling */
        .cart-item-row { 
            display: flex; 
            align-items: center; 
            padding: 20px 0; 
            border-bottom: 1px solid #eee; 
            position: relative;
            transition: opacity 0.3s;
        }
        .product-thumbnail { width: 100px; height: 100px; object-fit: contain; margin-right: 20px; }
        
        .item-details { flex-grow: 1; }
        .item-details h4 { margin: 0 0 5px 0; font-size: 1.2em; font-weight: 600; }
        .item-details p { margin: 0; font-size: 1em; color: #333; }
        
        /* Item Controls (Price, Quantity, Delete) */
        .item-controls { display: flex; align-items: center; min-width: 350px; justify-content: flex-end; }
        .item-controls .price { font-weight: 500; font-size: 1.1em; margin-right: 50px; }

        .quantity-controls { display: flex; align-items: center; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; margin-right: 20px; }
        .qty-btn { background: none; border: none; padding: 8px 12px; cursor: pointer; font-size: 1.1em; color: #333; }
        .qty-btn:hover:not(:disabled) { background-color: #f0f0f0; }
        .qty-input { width: 40px; text-align: center; border: none; font-weight: bold; padding: 8px 0; }
        
        .remove-icon { background: none; border: none; color: #999; font-size: 1.2em; cursor: pointer; margin-left: 20px; }
        .remove-icon:hover { color: #ff3b30; }

        /* Out-of-Stock Styling */
        .out-of-stock-row { opacity: 0.4; pointer-events: none; }
        .out-of-stock-row .stock-warning { font-size: 0.9em; color: #ff3b30; font-weight: 500; margin-top: 5px; pointer-events: auto; }
        .qty-btn:disabled, .qty-input:disabled { background-color: #f7f7f7; cursor: not-allowed; }

        /* Cart Summary Styling */
        .order-summary, .coupon-box { border: 1px solid #eee; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fff; }
        .order-summary h4 { font-weight: 600; font-size: 1.3em; margin-bottom: 15px; }
        .total-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 1em; }
        .final-total-row { font-size: 1.3em; font-weight: bold; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee; }
        .final-total-value { color: #000; }

        /* Coupon and Checkout Buttons */
        .coupon-box { display: flex; padding: 0; border: none; flex-direction: column; }
        .coupon-input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; }
        .apply-coupon-btn { background-color: #555; color: #fff; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; font-weight: 500; }
        .apply-coupon-btn:hover { background-color: #333; }

        .checkout-btn-area { margin-top: 20px; }
        .checkout-btn-area .btn-success { 
            background-color: #ffc107; /* Yellow background like the image */
            border-color: #ffc107; 
            color: #000;
            font-weight: bold;
            padding: 15px;
        }
        .checkout-btn-area .btn-success:hover { 
            background-color: #e0a800; 
            border-color: #e0a800;
        }
        .checkout-btn-area .disabled-checkout-warning {
            color: #dc3545;
            text-align: center;
            font-size: 0.9em;
            margin-top: 10px;
        }

    </style>
</head>
<body>
    <%- include('../partials/header.ejs') %>

    <div class="container mt-5">
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
                <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
            </ol>
        </nav>

        <h2>Shopping Cart</h2>

        <% 
            const hasOutOfStockItems = items.some(i => i.stock === 0);
            const totalDiscount = 0; // Assuming this is calculated on the server but not passed explicitly
            const totalDelivery = 0; // Assuming free delivery as per the original design image
            const finalTotal = subtotal - totalDiscount + totalDelivery; 
        %>

        <% if (items.length === 0) { %>
            <div class="alert alert-info">Your cart is empty.</div>
        <% } else { %>
            <div class="cart-layout">
                
                <div class="cart-items-column">
                    
                    <% items.forEach(item => { %>
                        <% const isOutOfStock = item.stock === 0; %>
                        
                        <div class="cart-item-row <%= isOutOfStock ? 'out-of-stock-row' : '' %>" id="row-<%= item.productId %>" data-stock="<%= item.stock %>">
                            
                            <img src="<%= item.image %>" alt="<%= item.name %>" class="product-thumbnail">
                            
                            <div class="item-details">
                                <h4><%= item.name %></h4>
                                <p>Rs.<%= item.price.toLocaleString('en-IN') %></p>
                                <% if (isOutOfStock) { %>
                                    <p class="stock-warning">⚠️ Out of Stock! Please remove to proceed.</p>
                                <% } %>
                            </div>
                            
                            <div class="item-controls">
                                <div class="quantity-controls">
                                    <button type="button" class="qty-btn minus-btn" data-id="<%= item.productId %>" 
                                            <%= isOutOfStock || item.quantity <= 1 ? 'disabled' : '' %> aria-label="Decrease quantity">-</button>
                                    
                                    <input type="text" value="<%= item.quantity %>" min="1" readonly 
                                           class="qty-input" id="qty-<%= item.productId %>" data-id="<%= item.productId %>" 
                                           <%= isOutOfStock ? 'disabled' : '' %>>
                                           
                                    <button type="button" class="qty-btn plus-btn" data-id="<%= item.productId %>" 
                                            <%= isOutOfStock || item.quantity >= item.stock ? 'disabled' : '' %> aria-label="Increase quantity">+</button>
                                </div>
                                
                                <button type="button" class="remove-icon remove-item" data-id="<%= item.productId %>" aria-label="Remove item">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    <% }) %>

                </div>

                <div class="cart-summary-column">

                    <div class="coupon-box">
                        <input type="text" placeholder="Enter Coupon Code" class="coupon-input">
                        <button class="apply-coupon-btn">Apply Coupon</button>
                    </div>

                    <div class="order-summary">
                        <h4>CART TOTALS</h4>
                        <div class="total-row">
                            <span>Subtotal</span>
                            <span id="cart-subtotal">Rs.<%= subtotal.toLocaleString('en-IN') %></span>
                        </div>
                        <div class="total-row">
                            <span>Delivery</span>
                            <span><%= totalDelivery === 0 ? 'FREE' : 'Rs.' + totalDelivery.toLocaleString('en-IN') %></span>
                        </div>
                        <div class="total-row">
                            <span>Discount</span>
                            <span>- Rs.<%= totalDiscount.toLocaleString('en-IN') %></span>
                        </div>
                        
                        <div class="final-total-row">
                            <span class="final-total-label">TOTAL</span>
                            <span class="final-total-value" id="cart-total">Rs.<%= finalTotal.toLocaleString('en-IN') %></span>
                        </div>
                    </div>

                    <div class="checkout-btn-area">
                        <button id="checkoutBtn" class="btn btn-success btn-lg w-100" 
                                <%= hasOutOfStockItems ? 'disabled' : '' %>>
                            Proceed to Checkout
                        </button>
                        <% if (hasOutOfStockItems) { %>
                            <p class="disabled-checkout-warning">Cannot checkout with out-of-stock items.</p>
                        <% } %>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

    <script>
        // --- Centralized Update Function (for AJAX success) ---
        function updateCartUI(productId, data) {
            // Update individual item subtotal
            const itemRow = document.getElementById('row-' + productId);
            if (itemRow) {
                // Assuming your item Subtotal is calculated/returned in the item data
                itemRow.querySelector('.item-controls .price').innerText = 'Rs.' + data.item.subtotal.toLocaleString('en-IN');
                
                // Update quantity input
                const qtyInput = document.getElementById('qty-' + productId);
                qtyInput.value = data.item.quantity;

                // Re-evaluate button state
                const plusBtn = itemRow.querySelector('.plus-btn');
                const minusBtn = itemRow.querySelector('.minus-btn');
                
                const stock = Number(itemRow.dataset.stock); // Get stock level
                const quantity = data.item.quantity;

                // Disable PLUS if stock reached
                plusBtn.disabled = (quantity >= stock);
                // Disable MINUS if quantity is 1
                minusBtn.disabled = (quantity <= 1);
            }

            // Update cart totals
            document.getElementById('cart-subtotal').innerText = 'Rs.' + data.cart.subtotal.toLocaleString('en-IN');
            document.getElementById('cart-total').innerText = 'Rs.' + data.cart.total.toLocaleString('en-IN');
            // Assuming the total is passed back with discount/delivery applied from server
        }

        // --- Handle Increment and Decrement Buttons ---
        document.querySelectorAll('.qty-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const productId = this.dataset.id;
                const itemRow = document.getElementById('row-' + productId);
                const qtyInput = itemRow.querySelector('.qty-input');
                let newQuantity = parseInt(qtyInput.value);
                const isPlus = this.classList.contains('plus-btn');

                // Determine new quantity
                newQuantity = isPlus ? newQuantity + 1 : newQuantity - 1;

                // Disable button immediately
                this.disabled = true;

                try {
                    const res = await fetch('/cart/update-quantity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productId, quantity: newQuantity })
                    });
                    const data = await res.json();

                    if (data.success) {
                        // Success: Update UI
                        updateCartUI(productId, data);
                    } else {
                        // Error: Show alert and revert quantity input visually
                        Swal.fire('Error', data.message, 'error');
                        // Revert the input value to the quantity the server confirmed
                        if (data.item) qtyInput.value = data.item.quantity;
                    }
                } catch (error) {
                    Swal.fire('Connection Error', 'Failed to communicate with server.', 'error');
                } finally {
                    // Re-enable all buttons in the row (re-evaluation happens in updateCartUI)
                    itemRow.querySelectorAll('.qty-btn').forEach(b => b.disabled = false);
                }
            });
        });


        // --- Handle Remove Item ---
     document.querySelectorAll('.remove-item').forEach(btn => {
    btn.addEventListener('click', async function() {
        const productId = this.dataset.id;
        
        const confirmDelete = await Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, remove it!'
        });
        
        if (!confirmDelete.isConfirmed) return;

        try {
            const res = await fetch('/cart/remove-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId })
            });

            // Check if response is JSON
            const contentType = res.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server did not return JSON');
            }

            const data = await res.json();

            if (data.success) {
                Swal.fire('Removed!', 'Item removed from cart', 'success');
                document.getElementById('row-' + productId).remove();
                
                // Update totals
                document.getElementById('cart-subtotal').innerText = 'Rs.' + data.cart.subtotal.toLocaleString('en-IN');
                document.getElementById('cart-total').innerText = 'Rs.' + data.cart.total.toLocaleString('en-IN');

                // Re-evaluate out-of-stock warning
                const remainingRows = document.querySelectorAll('.cart-item-row');
                const outOfStockRemaining = Array.from(remainingRows).some(row => Number(row.dataset.stock) === 0);
                
                const checkoutBtn = document.getElementById('checkoutBtn');
                checkoutBtn.disabled = outOfStockRemaining;
                const warning = document.querySelector('.disabled-checkout-warning');
                if (warning) warning.style.display = outOfStockRemaining ? 'block' : 'none';

                if (remainingRows.length === 0) {
                    window.location.reload();
                }
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'Failed to communicate with server.', 'error');
        }
    });
});

        // --- Checkout Button Logic ---
        document.getElementById('checkoutBtn')?.addEventListener('click', function() {
            if (this.disabled) {
                // If button is disabled due to EJS render, do nothing, the warning is visible.
                return;
            }
            window.location.href = '/checkout';
        });

    </script>
</body>
</html>