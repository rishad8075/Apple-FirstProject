<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Wishlist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* General Layout and Typography */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f7f7f7; color: #333; }
        .main-content { max-width: 1200px; margin: 50px auto; padding: 20px; background: #fff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        h2 { font-weight: 600; font-size: 2.2em; margin-bottom: 30px; }
        
        /* Wishlist Item Styling (Core Design Match) */
        .wishlist-item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 20px 0; 
            border-bottom: 1px solid #eee; 
            transition: opacity 0.3s;
        }
        .item-details-left { 
            display: flex; 
            align-items: center; 
            flex: 1.5;
        }
        .product-thumbnail { 
            width: 80px; 
            height: 80px; 
            object-fit: contain; 
            margin-right: 20px; 
        }
        .product-info h3 { 
            margin: 0; 
            font-size: 1.2em; 
            font-weight: 600; 
        }
        .product-info .price-display { 
            font-size: 1em; 
            color: #333; 
            margin-top: 5px; 
        }

        /* Stock Status Styling */
        .stock-status { 
            font-size: 0.9em; 
            font-weight: 500; 
            margin-left: 10px; 
        }
        .in-stock { 
            color: #007aff; 
        }
        .out-of-stock { 
            color: #ff3b30; 
        }

        /* Actions Right Section */
        .item-actions-right {
            display: flex;
            align-items: center;
            min-width: 350px;
            justify-content: flex-end;
            gap: 20px;
        }
        .date-added {
            font-size: 0.9em;
            color: #555;
            min-width: 100px; /* Aligns the actions better */
        }

        /* Buttons */
        .add-to-cart-btn {
            background-color: #ffc107; /* Yellow */
            color: #000;
            border: none;
            padding: 10px 18px;
            font-weight: bold;
            border-radius: 4px;
            text-transform: uppercase;
            transition: background-color 0.2s;
        }
        .add-to-cart-btn:hover:not(:disabled) {
            background-color: #e0a800;
        }
        .add-to-cart-btn:disabled {
            background-color: #ccc;
            color: #555;
            cursor: not-allowed;
        }
        
        .remove-item-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.2s;
        }
        .remove-item-btn:hover {
            color: #ff3b30;
        }

        /* Utility */
        .empty-wishlist-message {
            text-align: center;
            padding: 50px;
            border: 1px dashed #ccc;
            margin-top: 20px;
        }

    </style>
</head>
<body>
    <%- include('../partials/header.ejs') %>

    <div class="container main-content">
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Wishlist</li>
            </ol>
        </nav>

        <h2 class="text-uppercase">Wishlist</h2>

        <div class="wishlist-items-list">
            
            <% if (wishlistItems && wishlistItems.length > 0) { %>
                
                <% wishlistItems.forEach(function(item) { %>
                    <% 
                        // Assuming item structure based on your previous cart data and schema suggestion:
                        const productId = item.Product_id;
                        const productName = item.product.name;
                        const productPrice = item.product.price;
                        const productImageUrl = item.product.image;
                        const dateAdded = new Date(item.Created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                        // Assuming stock check is available in product object
                        const isInStock = item.product.stock > 0; 
                    %>

                    <div class="wishlist-item-row" id="wishlist-row-<%= productId %>" data-id="<%= productId %>">
                        <div class="item-details-left">
                            <img src="<%= productImageUrl %>" alt="<%= productName %>" class="product-thumbnail">
                            <div class="product-info">
                                <h3><%= productName %></h3>
                                <p class="price-display">
                                    Rs.<%= productPrice.toLocaleString('en-IN') %>
                                    <span class="stock-status <%= isInStock ? 'in-stock' : 'out-of-stock' %>">
                                        (<%= isInStock ? 'In Stock' : 'Out of Stock' %>)
                                    </span>
                                </p>
                            </div>
                        </div>

                        <div class="item-actions-right">
                            <span class="date-added">Added on <%= dateAdded %></span>
                            
                            <button type="button" 
                                    class="btn add-to-cart-btn" 
                                    data-id="<%= productId %>"
                                    <%= !isInStock ? 'disabled' : '' %>>
                                Add to Cart
                            </button>
                            
                            <button type="button" class="remove-item-btn" data-id="<%= productId %>" aria-label="Remove item">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                <% }); %>

            <% } else { %>
                <div class="empty-wishlist-message">
                    <p>Your Wishlist is empty. <a href="/shop">Start Browsing!</a></p>
                </div>
            <% } %>
        </div>
    </div>
    
    <%- include('../partials/footer.ejs') %> <script>
        // --- Handle Remove Item from Wishlist ---
        document.querySelectorAll('.remove-item-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const productId = this.dataset.id;
                
                const confirmDelete = await Swal.fire({
                    title: 'Remove item?',
                    text: "This will permanently remove the item from your wishlist.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ff3b30',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, remove it'
                });
                
                if (!confirmDelete.isConfirmed) return;

                try {
                    const res = await fetch('/wishlist/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productId })
                    });
                    
                    const data = await res.json();

                    if (data.success) {
                        Swal.fire('Removed!', 'Item removed from wishlist.', 'success');
                        document.getElementById('wishlist-row-' + productId).remove();
                        // Optional: Reload if the last item was removed to show the empty message
                        if (document.querySelectorAll('.wishlist-item-row').length === 0) {
                             window.location.reload(); 
                        }
                    } else {
                        Swal.fire('Error', data.message || 'Failed to remove item.', 'error');
                    }
                } catch (error) {
                    Swal.fire('Connection Error', 'Failed to communicate with server.', 'error');
                }
            });
        });

        // --- Handle Add to Cart from Wishlist ---
        document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const productId = this.dataset.id;
                
                // Disable button on click
                this.disabled = true;
                this.innerText = 'Adding...';

                try {
                    const res = await fetch('/cart/add-from-wishlist', { // Use a specific endpoint for this action
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productId, quantity: 1 }) // Always start with quantity 1
                    });
                    
                    const data = await res.json();

                    if (data.success) {
                        Swal.fire('Added!', 'Item added to your shopping cart.', 'success');
                        
                        // Recommended UX: Remove from wishlist after successful move to cart
                        // document.getElementById('wishlist-row-' + productId).remove(); 

                    } else {
                        Swal.fire('Error', data.message || 'Failed to add to cart.', 'error');
                    }
                } catch (error) {
                    Swal.fire('Connection Error', 'Failed to communicate with server.', 'error');
                } finally {
                    // Re-enable button on complete/failure
                    this.disabled = false;
                    this.innerText = 'Add to Cart';
                }
            });
        });
    </script>
</body>
</html>