<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Profile</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
.profile-image-container { position: relative; width: 150px; height: 150px; margin-bottom: 20px; }
.profile-image-container img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; cursor: pointer; }
.change-image-btn, .remove-image-btn {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    cursor: pointer;
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 5px;
    color: white;
}
.change-image-btn { background-color: rgba(0,0,0,0.6); bottom: 25px; }
.remove-image-btn { background-color: rgba(255,0,0,0.6); }
.error-msg { color: red; font-size: medium; }
.modal-body img { max-width: 100%; display: block; }
</style>
</head>
<body class="bg-light">

<div class="container py-5">
    <h3>Edit Profile</h3>

    <form id="editProfileForm" action="/user/profileEdit" method="POST" enctype="multipart/form-data">

        <!-- Profile Image -->
        <div class="profile-image-container mx-auto text-center">
            <img id="profileImage" src="<%= user.profileImage || '/images/user-default.png' %>" alt="Profile Image">
            <div class="change-image-btn" onclick="document.getElementById('profileImageInput').click()">Change Image</div>
            <div class="remove-image-btn" onclick="removeImage()">Remove Image</div>
            <input type="file" id="profileImageInput" name="profileImage" class="d-none" accept="image/*">
        </div>

        <!-- Name, Email, Phone, DOB -->
        <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <div id="error1" class="error-msg"></div>
            <input type="text" id="name" name="name" class="form-control" value="<%= user.name %>">
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <div id="error2" class="error-msg"></div>
            <input type="email" id="email" name="email" class="form-control" value="<%= user.email %>">
        </div>
        <div class="mb-3">
            <label for="phoneNumber" class="form-label">Phone</label>
            <div id="error3" class="error-msg"></div>
            <input type="text" id="phoneNumber" name="phoneNumber" class="form-control" value="<%= user.phoneNumber || '' %>">
        </div>
        <div class="mb-3">
            <label for="dob" class="form-label">Date of Birth</label>
            <input type="date" id="dob" name="dob" class="form-control" value="<%= user.dob ? user.dob.toISOString().split('T')[0] : '' %>">
        </div>

        <button type="submit" class="btn btn-success">Save Changes</button>
    </form>
</div>

<!-- Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Crop Profile Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="cropImage" src="">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="cropBtn">Crop & Upload</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const profileImage = document.getElementById('profileImage');
const profileImageInput = document.getElementById('profileImageInput');
const cropModal = new bootstrap.Modal(document.getElementById('cropModal'));
const cropImage = document.getElementById('cropImage');
let cropper;
let imageRemoved = false;

// Change Image -> Crop
profileImageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        cropImage.src = reader.result;
        cropModal.show();
        cropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 1, background: false });
    };
    reader.readAsDataURL(file);
});

// Crop & Upload
document.getElementById('cropBtn').addEventListener('click', () => {
    const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
    canvas.toBlob((blob) => {
        const fileInput = new File([blob], 'profile.png', { type: 'image/png' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(fileInput);
        profileImageInput.files = dataTransfer.files;

        profileImage.src = URL.createObjectURL(blob);
        cropModal.hide();
        cropper.destroy();
        imageRemoved = false;
    });
});

// Remove Image
function removeImage() {
    profileImage.src = '/images/user-default.png';
    profileImageInput.value = "";
    imageRemoved = true;
}

// Form submit
document.getElementById('editProfileForm').addEventListener('submit', function(e) {
    if (imageRemoved) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'removeImage';
        input.value = 'true';
        this.appendChild(input);
    }

    // Validation
    const nameField = document.getElementById("name");
    const phoneNumber = document.getElementById("phoneNumber");
    const email = document.getElementById("email");

    const error1 = document.getElementById("error1");
    const error2 = document.getElementById("error2");
    const error3 = document.getElementById("error3");

    let isValid = true;
    error1.textContent = "";
    error2.textContent = "";
    error3.textContent = "";

    const nameRegex = /^[A-Za-z ]+$/;
    if (nameField.value.trim().length < 3) {
        error1.textContent = "Name must be at least 3 characters long.";
        isValid = false;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email.value.trim())) {
        error2.textContent = "Enter a valid email address.";
        isValid = false;
    }

    const phoneRegex = /^[0-9]{10,15}$/;
    if (phoneNumber.value.trim() && !phoneRegex.test(phoneNumber.value.trim())) {
        error3.textContent = "Phone number must be 10-15 digits.";
        isValid = false;
    }

    if (!isValid) e.preventDefault();
});
</script>

</body>
</html>
