<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-accent: #0071e3;
            --bg-soft: #fbfbfd;
            --text-dark: #1d1d1f;
        }

        body { 
            background: var(--bg-soft); 
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-dark);
        }

        /* Responsive Layout matching your Order Details */
        .main-wrapper {
            margin-left: 280px;
            padding: 30px;
            transition: all 0.3s ease;
        }

        @media (max-width: 991px) {
            .main-wrapper { margin-left: 0; padding: 15px; }
        }

        /* Breadcrumb */
        .breadcrumb-item a { color: #86868b; text-decoration: none; font-size: 0.9rem; }

        /* Custom Cards */
        .detail-card {
            background: #fff;
            border-radius: 20px;
            border: 1px solid rgba(0,0,0,0.05);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        }

        .section-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Profile Image */
        .profile-image-container { 
            position: relative; 
            width: 120px; 
            height: 120px;
        }
        .profile-image-container img { 
            border-radius: 50%; 
            object-fit: cover; 
            border: 3px solid #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .profile-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; background: rgba(0,0,0,0.4);
            color: #fff; display: flex; justify-content: center; align-items: center;
            opacity: 0; cursor: pointer; transition: 0.3s;
        }
        .profile-image-container:hover .profile-overlay { opacity: 1; }

        /* Form Controls */
        .form-label-custom { font-size: 0.75rem; font-weight: 700; color: #86868b; text-transform: uppercase; margin-bottom: 5px; }
        .form-control {
            border-radius: 12px;
            padding: 12px 15px;
            border: 1px solid #d2d2d7;
            background: #fff;
        }
        .form-control:focus { box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1); border-color: var(--primary-accent); }

        .btn-action { border-radius: 12px; font-weight: 600; padding: 10px 20px; transition: 0.3s; }
        
        /* Referral Box */
        .referral-box {
            background: #f5f5f7;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>
</head>
<body>
<%- include('../partials/header') %>
<%- include('../partials/UserSide-bar.ejs') %>

<div class="main-wrapper">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i> Home</a></li>
            <li class="breadcrumb-item active">My Profile</li>
        </ol>
    </nav>

    <h2 class="fw-800 mb-4">Account Settings</h2>

    <div class="row">
        <div class="col-lg-8">
            <div class="detail-card">
                <div class="d-flex flex-column flex-md-row align-items-center gap-4 mb-4">
                    <div class="profile-image-container">
                        <img src="<%= user.profileImage || '/images/user-default.png' %>" alt="Profile" width="120" height="120">
                        <div class="profile-overlay">
                            <i class="fas fa-camera fa-lg"></i> 
                        </div>
                        <input type="file" id="profileImageInput" class="d-none" accept="image/*">
                    </div>
                    <div class="text-center text-md-start">
                        <h4 class="fw-700 mb-1"><%= user.name %></h4>
                        <p class="text-muted mb-2"><%= user.email %></p>
                        <div class="d-flex flex-wrap gap-2 justify-content-center justify-content-md-start">
                            <a href="/user/edit-profile" class="btn btn-dark btn-action btn-sm">Edit Profile</a>
                            <button class="btn btn-outline-primary btn-action btn-sm" onclick="changeEmail()">Change Email</button>
                        </div>
                    </div>
                </div>

                <hr class="my-4" style="opacity: 0.1;">

                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label-custom">Phone Number</label>
                        <p class="fw-600"><%= user.phoneNumber || 'Not provided' %></p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-custom">Date of Birth</label>
                        <p class="fw-600"><%= user.dob ? user.dob.toDateString() : 'Not provided' %></p>
                    </div>
                </div>
            </div>

            <div class="detail-card" id="changePasswordForm">
                <h5 class="section-title"><i class="fas fa-lock"></i> Security & Password</h5>
                <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
                    <div class="alert alert-danger" style="border-radius: 12px;"><%= errorMessage %></div>
                <% } %>
                <form action="/user/change-password" method="POST">
                    <div class="mb-3">
                        <label class="form-label-custom">Current Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" name="currentPassword" id="currentPassword" placeholder="Enter current password">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('currentPassword', this)" style="border-radius: 0 12px 12px 0;">üëÅÔ∏è</button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label-custom">New Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="newPassword" id="password" placeholder="Min 6 chars">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('password', this)" style="border-radius: 0 12px 12px 0;">üëÅÔ∏è</button>
                            </div>
                            <div id="error1" style="color: #e03131; font-size: 0.8rem; margin-top: 5px;"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label-custom">Confirm New Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="confirmPassword" id="confirmPassword" placeholder="Repeat password">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword', this)" style="border-radius: 0 12px 12px 0;">üëÅÔ∏è</button>
                            </div>
                            <div id="error2" style="color: #e03131; font-size: 0.8rem; margin-top: 5px;"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-action px-4">Update Password</button>
                    <a href="/user/forgotPassword" class="btn btn-link text-decoration-none small ms-2">Forgot Password?</a>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="detail-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
                <h5 class="section-title text-white"><i class="fas fa-gift"></i> Invite & Earn</h5>
                <p class="small opacity-90">Invite your friends and earn <strong>‚Çπ100</strong> in your wallet when they sign up.</p>
                
                <label class="form-label-custom text-white opacity-75">Your Referral Code</label>
                <div class="input-group mb-2">
                    <input type="text" class="form-control border-0" value="<%= user.referralCode %>" readonly id="referralCode" style="background: rgba(255,255,255,0.2); color: white;">
                    <button class="btn btn-light" onclick="copyText('referralCode')" style="border-radius: 0 12px 12px 0; font-weight: 600;">
                        Copy
                    </button>
                </div>
            </div>

            <div class="detail-card">
                <h5 class="section-title"><i class="fas fa-headset"></i> Need Help?</h5>
                <p class="small text-muted">Have questions regarding your account or privacy?</p>
                <a href="/contact" class="btn btn-outline-dark btn-action w-100">Contact Support</a>
            </div>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- ALL ORIGINAL LOGIC PRESERVED ---
    function copyText(id) {
        const input = document.getElementById(id);
        input.select();
        input.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(input.value);
        Swal.fire({ icon: "success", title: "Copied!", text: "Referral copied to clipboard", timer: 1200, showConfirmButton: false });
    }

    function togglePassword(fieldId, btn) {
        const field = document.getElementById(fieldId);
        if (field.type === "password") {
            field.type = "text";
            btn.textContent = "HIDE";
        } else {
            field.type = "password";
            btn.textContent = "üëÅÔ∏è";
        }
    }

    function changeEmail() {
        window.location.href ="/user/ChangeEmail-valid";
    }

    document.querySelector("#changePasswordForm form").addEventListener("submit", async function(e) {
        e.preventDefault();
        const currentPassword = document.querySelector("[name=currentPassword]");
        const password = document.getElementById("password");
        const confirmPassword = document.getElementById("confirmPassword");
        const error1 = document.getElementById("error1");
        const error2 = document.getElementById("error2");

        error1.textContent = "";
        error2.textContent = "";
        let valid = true;

        if (!password.value || !confirmPassword.value) {
            error1.textContent = "Password cannot be empty";
            valid = false;
        }
        if (password.value.length < 6) {
            error1.textContent = "Password must be at least 6 characters";
            valid = false;
        }
        if (password.value !== confirmPassword.value) {
            error2.textContent = "Passwords do not match";
            valid = false;
        }
        if (!valid) return;

        try {
            const response = await fetch("/user/change-password", {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    currentPassword: currentPassword.value,
                    newPassword: password.value
                })
            });
            const data = await response.json();
            if (data.success) {
                Swal.fire("Updated!", data.message, "success").then(() => { window.location.reload(); });
            } else {
                Swal.fire("Error", data.message, "error");
            }
        } catch (err) {
            Swal.fire("Error", "Something went wrong!", "error");
        }
    });
</script>
</body>
</html>